{% extends "admin/layout.html" %}

{% block title %}AI 分析与报告{% endblock %}

{% block breadcrumb %}AI 分析与报告{% endblock %}

{% block content %}
<style>
    /* Sci-Fi Theme Variables */
    :root {
        --sci-fi-bg: #0a0a12;
        --sci-fi-panel: rgba(16, 20, 30, 0.95);
        --sci-fi-border: #00ffff;
        --sci-fi-text: #e0ffff;
        --sci-fi-accent: #00ff00;
        --sci-fi-user-bg: rgba(0, 255, 255, 0.15);
        --sci-fi-ai-bg: rgba(0, 0, 0, 0.6);
        --sci-fi-grid: rgba(0, 255, 255, 0.05);
        --sci-fi-item-hover: rgba(0, 255, 255, 0.1);
        --sci-fi-item-active: rgba(0, 255, 255, 0.2);
    }

    /* Container Overrides */
    .layui-card {
        background: transparent;
        box-shadow: none;
        border: none;
    }
    
    .layui-card-header {
        background: var(--sci-fi-panel);
        color: var(--sci-fi-border);
        border-bottom: 1px solid var(--sci-fi-border);
        font-family: 'Orbitron', 'Segoe UI', sans-serif;
        letter-spacing: 1px;
        text-shadow: 0 0 5px var(--sci-fi-border);
    }

    .main-container {
        display: flex;
        height: calc(100vh - 150px);
        background: var(--sci-fi-bg);
        border: 1px solid rgba(0, 255, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: rgba(0, 0, 0, 0.8);
        border-right: 1px solid var(--sci-fi-border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }

    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    }

    .new-chat-btn {
        width: 100%;
        background: transparent;
        border: 1px dashed var(--sci-fi-border);
        color: var(--sci-fi-text);
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .new-chat-btn:hover {
        background: var(--sci-fi-item-hover);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
    }

    .session-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
    }

    .session-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
        color: #aaa;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .session-item:hover {
        background: var(--sci-fi-item-hover);
        color: #fff;
    }

    .session-item.active {
        background: var(--sci-fi-item-active);
        color: var(--sci-fi-border);
        border-left: 3px solid var(--sci-fi-border);
    }

    .session-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 13px;
        flex: 1;
    }
    
    .delete-btn {
        opacity: 0;
        color: #ff4444;
        padding: 2px 5px;
        transition: opacity 0.2s;
    }
    
    .session-item:hover .delete-btn {
        opacity: 1;
    }

    /* Chat Area */
    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-image: 
            linear-gradient(var(--sci-fi-grid) 1px, transparent 1px),
            linear-gradient(90deg, var(--sci-fi-grid) 1px, transparent 1px);
        background-size: 20px 20px;
        position: relative;
    }

    /* HUD Elements */
    .chat-container::before {
        content: "";
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        pointer-events: none;
        background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.4) 100%);
        z-index: 0;
    }

    .chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: relative;
        z-index: 1;
        scrollbar-width: thin;
        scrollbar-color: var(--sci-fi-border) var(--sci-fi-bg);
    }

    /* Custom Scrollbar */
    .chat-history::-webkit-scrollbar,
    .session-list::-webkit-scrollbar {
        width: 6px;
    }
    .chat-history::-webkit-scrollbar-track,
    .session-list::-webkit-scrollbar-track {
        background: var(--sci-fi-bg);
    }
    .chat-history::-webkit-scrollbar-thumb,
    .session-list::-webkit-scrollbar-thumb {
        background: var(--sci-fi-border);
        border-radius: 3px;
    }

    .chat-input-area {
        padding: 20px;
        background: var(--sci-fi-panel);
        border-top: 1px solid var(--sci-fi-border);
        display: flex;
        gap: 10px;
        position: relative;
        z-index: 2;
        box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
    }

    .message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 2px;
        line-height: 1.6;
        position: relative;
        font-family: 'Segoe UI', sans-serif;
    }

    /* User Message Style */
    .message.user {
        align-self: flex-end;
        background: var(--sci-fi-user-bg);
        color: var(--sci-fi-text);
        border: 1px solid var(--sci-fi-border);
        border-right: 4px solid var(--sci-fi-border);
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }

    /* Assistant Message Style */
    .message.assistant {
        align-self: flex-start;
        background: var(--sci-fi-ai-bg);
        color: var(--sci-fi-text);
        border: 1px solid var(--sci-fi-accent);
        border-left: 4px solid var(--sci-fi-accent);
        clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px));
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
    }

    .message.system {
        align-self: center;
        background: rgba(0, 255, 255, 0.05);
        color: #88cccc;
        font-size: 12px;
        padding: 5px 15px;
        border: 1px dashed rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Thinking Process Styles */
    .thinking-container {
        margin-bottom: 15px;
        border: 1px solid rgba(0, 255, 255, 0.2);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .thinking-header {
        padding: 8px 12px;
        background: rgba(0, 255, 255, 0.05);
        color: var(--sci-fi-accent);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
    }

    .thinking-header:hover {
        background: rgba(0, 255, 255, 0.1);
    }

    .thinking-body {
        padding: 10px;
        border-top: 1px solid rgba(0, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: max-height 0.3s ease-out;
    }
    
    .thinking-body.collapsed {
        display: none;
    }

    .thinking-step {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-size: 12px;
        color: #aaa;
        padding: 4px 0;
        animation: fadeIn 0.3s ease-in;
    }

    .thinking-step i {
        margin-top: 2px;
        color: var(--sci-fi-border);
    }

    .thinking-step.active {
        color: #fff;
    }
    
    .thinking-step.active i {
        color: var(--sci-fi-accent);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-content img {
        max-width: 100%;
        border: 1px solid var(--sci-fi-border);
    }

    .message-content pre {
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border: 1px solid #444;
        color: #00ff00;
        border-radius: 4px;
        overflow-x: auto;
    }

    /* Input Styling */
    #user-input {
        flex: 1;
        padding: 12px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #444;
        border-radius: 2px;
        resize: none;
        height: 50px;
        color: var(--sci-fi-text);
        font-family: inherit;
        transition: all 0.3s;
    }

    #user-input:focus {
        border-color: var(--sci-fi-border);
        box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
        outline: none;
    }

    /* Button Styling */
    #send-btn {
        height: 50px;
        width: 100px;
        background: transparent;
        color: var(--sci-fi-border);
        border: 1px solid var(--sci-fi-border);
        position: relative;
        overflow: hidden;
        transition: all 0.3s;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 1px;
    }

    #send-btn:hover:not(:disabled) {
        background: var(--sci-fi-border);
        color: #000;
        box-shadow: 0 0 15px var(--sci-fi-border);
    }

    #send-btn:disabled {
        border-color: #555;
        color: #555;
        cursor: not-allowed;
    }

    /* Select Styling */
    #model-select {
        background-color: rgba(0, 0, 0, 0.5);
        color: var(--sci-fi-border);
        border: 1px solid var(--sci-fi-border);
    }
    #model-select option {
        background-color: #000;
        color: var(--sci-fi-text);
    }

    /* Markdown Styles Override */
    .markdown-body {
        color: var(--sci-fi-text);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;
    }
    .markdown-body table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 16px;
        background: rgba(0,0,0,0.3);
    }
    .markdown-body table th,
    .markdown-body table td {
        padding: 8px 13px;
        border: 1px solid #444;
    }
    .markdown-body table tr:nth-child(2n) {
        background-color: rgba(255,255,255,0.05);
    }
    .markdown-body code {
        background-color: rgba(255,255,255,0.1);
        color: var(--sci-fi-accent);
        padding: 2px 4px;
        border-radius: 3px;
    }
</style>

<div class="layui-card">
    <div class="layui-card-header">
        <i class="layui-icon layui-icon-engine"></i> 智能数据分析终端
        <div class="layui-layout-right" style="padding-right: 20px; top: 0; display: flex; align-items: center; height: 100%;">
            {# 兼容性处理 #}
            {% set available_models = ai_models %}
            {% if not available_models and ai_model %}
                {% set available_models = [ai_model] %}
                {% set current_model = ai_model %}
            {% endif %}

            {% if available_models %}
            <div style="display: flex; align-items: center;">
                <label style="margin-right: 10px; font-weight: normal; color: var(--sci-fi-border);">AI 引擎:</label>
                <select id="model-select" class="layui-input" style="height: 30px; width: auto; display: inline-block; padding-right: 30px;">
                    {% for model in available_models %}
                    <option value="{{ model.id }}" {% if current_model and current_model.id == model.id %}selected{% endif %}>
                        {{ model.name }} ({{ model.model_name }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <span class="layui-badge layui-bg-gray">系统离线</span>
            {% endif %}
        </div>
    </div>
    <div class="layui-card-body" style="padding: 0;">
        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="new-chat-btn" onclick="createNewChat()">
                        <i class="layui-icon layui-icon-add-1"></i> 新建对话
                    </div>
                </div>
                <div class="session-list" id="session-list">
                    {% for session in sessions %}
                    <div class="session-item" onclick="loadSession('{{ session.id }}', this)" data-id="{{ session.id }}">
                        <div class="session-title">{{ session.title }}</div>
                        <i class="layui-icon layui-icon-delete delete-btn" onclick="deleteSession(event, '{{ session.id }}')"></i>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-container">
                <div class="chat-history" id="chat-history">
                    <div class="message system">
                        系统就绪，等待指令... <br>
                        欢迎使用 AI 智能分析助手。您可以询问关于用户、房间、消息等数据的统计分析问题。
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea id="user-input" placeholder="输入指令或问题..." {% if not current_model %}disabled{% endif %}></textarea>
                    <button class="layui-btn" id="send-btn" {% if not current_model %}disabled{% endif %}>
                        <i class="layui-icon layui-icon-release"></i> 发送指令
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let currentSessionId = null;
    let modelId = document.getElementById('model-select') ? document.getElementById('model-select').value : null;

    // Document Ready
    document.addEventListener('DOMContentLoaded', function() {
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modelSelect = document.getElementById('model-select');

        if (modelSelect) {
            modelSelect.addEventListener('change', function() {
                modelId = this.value;
                const modelName = this.options[this.selectedIndex].text;
                appendMessage('system', `引擎已切换: ${modelName}`);
            });
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    function createNewChat() {
        currentSessionId = null;
        document.getElementById('chat-history').innerHTML = `
            <div class="message system">
                系统就绪，等待指令... <br>
                欢迎使用 AI 智能分析助手。您可以询问关于用户、房间、消息等数据的统计分析问题。
            </div>
        `;
        // Remove active class from sidebar items
        document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
    }

    async function loadSession(sessionId, element) {
        if (currentSessionId === sessionId) return;
        
        // UI Update
        document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');
        
        currentSessionId = sessionId;
        const historyContainer = document.getElementById('chat-history');
        historyContainer.innerHTML = '<div class="message system">正在加载会话数据...</div>';
        
        try {
            const response = await fetch(`/admin/ai-analysis/sessions/${sessionId}/messages`);
            const data = await response.json();
            
            if (data.status === 'success') {
                historyContainer.innerHTML = '';
                data.messages.forEach(msg => {
                    appendMessage(msg.role === 'ai' ? 'assistant' : msg.role, msg.content);
                });
                historyContainer.scrollTop = historyContainer.scrollHeight;
            } else {
                appendMessage('system', '加载会话失败: ' + data.message);
            }
        } catch (e) {
            appendMessage('system', '加载会话失败: ' + e.message);
        }
    }

    async function deleteSession(event, sessionId) {
        event.stopPropagation(); // Prevent loading session
        if (!confirm('确定要删除此对话吗？')) return;
        
        try {
            const response = await fetch(`/admin/ai-analysis/sessions/${sessionId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                const item = document.querySelector(`.session-item[data-id="${sessionId}"]`);
                if (item) item.remove();
                
                if (currentSessionId === sessionId) {
                    createNewChat();
                }
            } else {
                alert('删除失败: ' + data.message);
            }
        } catch (e) {
            alert('删除失败: ' + e.message);
        }
    }

    function appendMessage(role, content) {
        const historyContainer = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        if (role === 'assistant') {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content markdown-body';
            contentDiv.innerHTML = marked.parse(content);
            div.appendChild(contentDiv);
        } else {
            div.textContent = content;
        }
        
        historyContainer.appendChild(div);
        historyContainer.scrollTop = historyContainer.scrollHeight;
        return div;
    }

    async function sendMessage() {
        const userInput = document.getElementById('user-input');
        const historyContainer = document.getElementById('chat-history');
        const text = userInput.value.trim();
        
        if (!text) return;

        userInput.value = '';
        appendMessage('user', text);

        try {
            const response = await fetch("{{ url_for('admin.ai_analysis_chat') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: text,
                    session_id: currentSessionId,
                    model_id: modelId
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || '网络响应异常');
            }

            // Create assistant message container
            const assistantMsgDiv = document.createElement('div');
            assistantMsgDiv.className = 'message assistant';
            
            // Thinking process container (created dynamically)
            let thinkingContainer = null;
            let thinkingBody = null;

            // Content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content markdown-body';
            assistantMsgDiv.appendChild(contentDiv);
            
            historyContainer.appendChild(assistantMsgDiv);
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let assistantContent = '';
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split('\n');
                // Keep the last partial line in buffer
                if (buffer.endsWith('\n')) {
                    buffer = '';
                } else {
                    buffer = lines.pop();
                }
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const event = JSON.parse(line);
                        
                        if (event.type === 'session_id') {
                            // If this was a new chat, we get the session ID here
                            if (!currentSessionId) {
                                currentSessionId = event.content;
                                // Refresh session list (simple way: reload page or add item manually)
                                // Adding manually is better
                                addSessionToList(currentSessionId, text);
                            }
                        } else if (event.type === 'token') {
                            assistantContent += event.content;
                            contentDiv.innerHTML = marked.parse(assistantContent);
                        } else if (event.type === 'status') {
                            if (!thinkingContainer) {
                                thinkingContainer = document.createElement('div');
                                thinkingContainer.className = 'thinking-container';
                                thinkingContainer.innerHTML = `
                                    <div class="thinking-header" onclick="this.nextElementSibling.classList.toggle('collapsed'); this.querySelector('.arrow').classList.toggle('layui-icon-down'); this.querySelector('.arrow').classList.toggle('layui-icon-right')">
                                        <span><i class="layui-icon layui-icon-engine"></i> AI 思考过程</span>
                                        <i class="layui-icon layui-icon-down arrow"></i>
                                    </div>
                                    <div class="thinking-body"></div>
                                `;
                                assistantMsgDiv.insertBefore(thinkingContainer, contentDiv);
                                thinkingBody = thinkingContainer.querySelector('.thinking-body');
                            }
                            
                            const step = document.createElement('div');
                            step.className = 'thinking-step active';
                            step.innerHTML = `<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> <span>${event.content}</span>`;
                            
                            // Mark previous steps as inactive
                            const prevSteps = thinkingBody.querySelectorAll('.thinking-step');
                            if (prevSteps.length > 0) {
                                const lastStep = prevSteps[prevSteps.length - 1];
                                lastStep.classList.remove('active');
                                const icon = lastStep.querySelector('i');
                                icon.className = 'layui-icon layui-icon-ok';
                            }
                            
                            thinkingBody.appendChild(step);
                            historyContainer.scrollTop = historyContainer.scrollHeight;
                        } else if (event.type === 'error') {
                            appendMessage('system', '错误: ' + event.content);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE event:', e);
                    }
                }
                historyContainer.scrollTop = historyContainer.scrollHeight;
            }
            
            // Finalize thinking process
            if (thinkingBody) {
                const prevSteps = thinkingBody.querySelectorAll('.thinking-step');
                if (prevSteps.length > 0) {
                    const lastStep = prevSteps[prevSteps.length - 1];
                    lastStep.classList.remove('active');
                    const icon = lastStep.querySelector('i');
                    icon.className = 'layui-icon layui-icon-ok';
                }
            }

        } catch (e) {
            appendMessage('system', '发送失败: ' + e.message);
        } finally {
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="layui-icon layui-icon-release"></i> 发送指令';
            }
        }
    }

    function addSessionToList(id, title) {
        // Truncate title
        if (title.length > 20) title = title.substring(0, 20) + '...';
        
        const list = document.getElementById('session-list');
        const div = document.createElement('div');
        div.className = 'session-item active';
        div.setAttribute('onclick', `loadSession(${id}, this)`);
        div.setAttribute('data-id', id);
        div.innerHTML = `
            <div class="session-title">${title}</div>
            <i class="layui-icon layui-icon-delete delete-btn" onclick="deleteSession(event, ${id})"></i>
        `;
        
        // Insert at top
        list.insertBefore(div, list.firstChild);
        
        // Remove active from others
        document.querySelectorAll('.session-item').forEach(el => {
            if (el !== div) el.classList.remove('active');
        });
    }
</script>
{% endblock %}
