{% extends "admin/layout.html" %}

{% block content %}
<style>
    /* Scoped styles for dashboard content */
    .dashboard-container {
        background-color: #0b122e;
        color: #fff;
        padding: 20px;
        min-height: calc(100vh - 150px);
        font-family: "Microsoft YaHei", sans-serif;
        border-radius: 4px;
    }
    
    /* Dashboard Header inside content */
    .dashboard-header {
        height: 60px;
        background: linear-gradient(to right, rgba(15, 28, 58, 0.8), rgba(11, 18, 46, 0.8));
        border-bottom: 2px solid #00f6ff;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 0 10px rgba(0, 246, 255, 0.2);
    }
    .dashboard-header h1 {
        margin: 0;
        font-size: 24px;
        color: #00f6ff;
        text-shadow: 0 0 5px rgba(0, 246, 255, 0.5);
    }
    .dashboard-time {
        font-size: 16px;
        color: #00f6ff;
    }

    /* Cards */
    .dashboard-panel {
        background: rgba(16, 28, 58, 0.6);
        border: 1px solid #1a3c75;
        box-shadow: 0 0 15px rgba(0, 100, 255, 0.1) inset;
        margin-bottom: 20px;
        position: relative;
        padding: 15px;
    }
    .dashboard-panel::before {
        content: "";
        position: absolute;
        top: 0; left: 0;
        width: 10px; height: 10px;
        border-top: 2px solid #00f6ff;
        border-left: 2px solid #00f6ff;
    }
    .dashboard-panel::after {
        content: "";
        position: absolute;
        top: 0; right: 0;
        width: 10px; height: 10px;
        border-top: 2px solid #00f6ff;
        border-right: 2px solid #00f6ff;
    }
    .dashboard-panel-footer::before {
        content: "";
        position: absolute;
        bottom: 0; left: 0;
        width: 10px; height: 10px;
        border-bottom: 2px solid #00f6ff;
        border-left: 2px solid #00f6ff;
    }
    .dashboard-panel-footer::after {
        content: "";
        position: absolute;
        bottom: 0; right: 0;
        width: 10px; height: 10px;
        border-bottom: 2px solid #00f6ff;
        border-right: 2px solid #00f6ff;
    }
    
    .dashboard-panel h2 {
        font-size: 18px;
        color: #fff;
        margin-bottom: 15px;
        border-left: 4px solid #00f6ff;
        padding-left: 10px;
    }
    
    /* Stats */
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        margin-bottom: 10px;
        border-radius: 4px;
    }
    .stat-label { font-size: 14px; color: #aaa; }
    .stat-value { font-size: 24px; color: #ffeb7b; font-weight: bold; }
    
    /* Charts */
    .chart-box {
        height: 300px;
        width: 100%;
    }
    
    /* Warning List */
    .warning-list {
        height: 200px;
        overflow-y: auto;
    }
    .warning-item {
        padding: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #ff4d4f;
        font-size: 12px;
        animation: fadeIn 0.5s;
    }
    .warning-item .time { color: #888; margin-right: 10px; }
    
    /* AI Box */
    .ai-box {
        background: rgba(0, 100, 0, 0.1);
        border: 1px solid #00ff00;
        padding: 10px;
        color: #00ff00;
        font-family: monospace;
        height: 150px;
        overflow-y: auto;
        text-shadow: 0 0 5px #00ff00;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>智联星队·可视化数字大屏</h1>
        <div style="display: flex; align-items: center;">
            <button id="btn-report" class="layui-btn layui-btn-normal layui-btn-sm" style="margin-right: 15px; background-color: #00f6ff; color: #0b122e; border: none; font-weight: bold; box-shadow: 0 0 5px rgba(0, 246, 255, 0.5);">
                <i class="layui-icon layui-icon-export"></i> 生成分析报告
            </button>
            <div class="dashboard-time" id="clock">00:00:00</div>
        </div>
    </div>

    <div class="layui-row layui-col-space20">
        <!-- Left Column -->
        <div class="layui-col-md3">
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>平台数据总览</h2>
                <div class="stat-item">
                    <span class="stat-label">注册用户</span>
                    <span class="stat-value" id="user-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">聊天室总数</span>
                    <span class="stat-value" id="room-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">历史消息</span>
                    <span class="stat-value" id="message-count">0</span>
                </div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>数据分布</h2>
                <div id="pie-chart" class="chart-box" style="height: 250px;"></div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>群舆论倾向 (Top 5)</h2>
                <div id="sentiment-chart" class="chart-box" style="height: 250px;"></div>
            </div>
        </div>
        
        <!-- Center Column -->
        <div class="layui-col-md6">
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>实时消息趋势</h2>
                <div id="line-chart" class="chart-box" style="height: 400px;"></div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>实时预警监控</h2>
                <div class="warning-list" id="warning-list">
                    <div class="warning-item">正在连接监控系统...</div>
                </div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>虚拟用户活动轨迹 (模拟)</h2>
                <div id="trajectory-chart" class="chart-box" style="height: 250px;"></div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>重点监控 (人员/群组)</h2>
                <div class="monitor-search-box" style="position: relative; margin-bottom: 15px;">
                    <input type="text" id="monitor-search" placeholder="输入用户名或群名搜索..." style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid #00f6ff; color: #fff; padding: 8px; border-radius: 4px; box-sizing: border-box;">
                    <div id="search-results" style="display:none; position: absolute; top: 100%; left: 0; width: 100%; background: #0b122e; border: 1px solid #00f6ff; z-index: 100; max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div id="monitor-content" style="min-height: 180px; color: #eee; font-size: 14px;">
                    <div style="text-align: center; color: #666; padding-top: 50px;">请搜索并选择监控对象</div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="layui-col-md3">
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>AI 智能分析</h2>
                <div class="ai-box" id="ai-summary">
                    正在分析系统数据...
                </div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>实时活动监控</h2>
                <div id="activity-monitor" style="min-height: 200px; max-height: 300px; color: #eee; font-size: 12px; overflow-y: auto;">
                    <div style="text-align: center; color: #666; padding-top: 50px;">正在加载实时活动数据...</div>
                </div>
            </div>

            <div class="dashboard-panel">
                <div class="dashboard-panel-footer"></div>
                <h2>活跃房间排行</h2>
                <div id="bar-chart" class="chart-box" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString();
    }, 1000);

    // Charts
    let lineChart, pieChart, barChart, sentimentChart, trajectoryChart;
    let trajectoryTimer = null;
    let currentRoomList = [];
    
    try {
        if (typeof echarts === 'undefined') {
            console.error('ECharts is not loaded.');
            document.querySelector('.dashboard-container').insertAdjacentHTML('afterbegin', '<div style="background:red;color:white;padding:10px;text-align:center;">错误: ECharts 图表库未能加载，请检查网络连接或 CDN 配置。仅显示文本数据。</div>');
        } else {
            lineChart = echarts.init(document.getElementById('line-chart'));
            pieChart = echarts.init(document.getElementById('pie-chart'));
            barChart = echarts.init(document.getElementById('bar-chart'));
            sentimentChart = echarts.init(document.getElementById('sentiment-chart'));
            trajectoryChart = echarts.init(document.getElementById('trajectory-chart'));

            // Resize charts
            window.addEventListener('resize', () => {
                lineChart && lineChart.resize();
                pieChart && pieChart.resize();
                barChart && barChart.resize();
                sentimentChart && sentimentChart.resize();
                trajectoryChart && trajectoryChart.resize();
            });
        }
    } catch (e) {
        console.error('Error initializing charts:', e);
    }


    // Report Generation
    document.getElementById('btn-report').addEventListener('click', function() {
        const btn = this;
        const originalContent = btn.innerHTML;
        
        // Prevent double click
        if (btn.disabled) return;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 生成中...';
        
        fetch("{{ url_for('admin.generate_dashboard_report') }}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('生成报告失败');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().slice(0,10);
                a.download = `智联星队_运营分析报告_${dateStr}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Use layui layer if available, otherwise alert
                if (typeof layer !== 'undefined') {
                    layer.msg('报告已生成并下载', {icon: 1});
                } else {
                    alert('报告已生成并下载');
                }
            })
            .catch(err => {
                console.error(err);
                if (typeof layer !== 'undefined') {
                    layer.msg('生成报告失败，请检查网络或稍后重试', {icon: 2});
                } else {
                    alert('生成报告失败');
                }
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    });

    // Fetch Data
    function fetchData() {
        console.log("Fetching dashboard data...");
        fetch("{{ url_for('admin.dashboard_stats') }}")
            .then(response => {
                if (!response.ok) {
                    console.error('Network response was not ok:', response.status, response.statusText);
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dashboard data received:", data);
                // Update Stats
                document.getElementById('user-count').innerText = data.user_count;
                document.getElementById('room-count').innerText = data.room_count;
                document.getElementById('message-count').innerText = data.message_count;
                
                // Update AI Summary
                document.getElementById('ai-summary').innerText = data.ai_summary;
                
                // Update Line Chart
                if (lineChart) {
                    lineChart.setOption({
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'axis' },
                        grid: { top: '10%', bottom: '10%', left: '10%', right: '10%' },
                        xAxis: {
                            type: 'category',
                            data: data.dates,
                            axisLine: { lineStyle: { color: '#00f6ff' } },
                            axisLabel: { color: '#fff' }
                        },
                        yAxis: {
                            type: 'value',
                            axisLine: { lineStyle: { color: '#00f6ff' } },
                            axisLabel: { color: '#fff' },
                            splitLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
                        },
                        series: [{
                            data: data.msg_counts,
                            type: 'line',
                            smooth: true,
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 246, 255, 0.5)' },
                                    { offset: 1, color: 'rgba(0, 246, 255, 0)' }
                                ])
                            },
                            itemStyle: { color: '#00f6ff' }
                        }]
                    });
                }
                
                // Update Pie Chart
                if (pieChart) {
                    pieChart.setOption({
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'item' },
                        series: [{
                            name: '数据分布',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            label: { show: false, position: 'center' },
                            emphasis: {
                                label: { show: true, fontSize: '20', fontWeight: 'bold', color: '#fff' }
                            },
                            labelLine: { show: false },
                            data: [
                                { value: data.user_count, name: '用户', itemStyle: { color: '#37a2da' } },
                                { value: data.room_count, name: '房间', itemStyle: { color: '#32c5e9' } },
                                { value: data.message_count, name: '消息', itemStyle: { color: '#67e0e3' } }
                            ]
                        }]
                    });
                }
                
                // Update Bar Chart (Active Rooms)
                if (barChart) {
                    const roomNames = data.active_rooms.map(r => r.name);
                    const roomMsgs = data.active_rooms.map(r => r.msg_count);
                    
                    barChart.setOption({
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'axis' },
                        grid: { top: '10%', bottom: '10%', left: '20%', right: '10%' },
                        xAxis: {
                            type: 'value',
                            axisLine: { lineStyle: { color: '#00f6ff' } },
                            axisLabel: { color: '#fff' },
                            splitLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
                        },
                        yAxis: {
                            type: 'category',
                            data: roomNames,
                            axisLine: { lineStyle: { color: '#00f6ff' } },
                            axisLabel: { color: '#fff' }
                        },
                        series: [{
                            data: roomMsgs,
                            type: 'bar',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#83bff6' },
                                    { offset: 0.5, color: '#188df0' },
                                    { offset: 1, color: '#188df0' }
                                ])
                            }
                        }]
                    });
                }
                
                // Update Sentiment Chart
                if (sentimentChart && data.sentiment_data) {
                    sentimentChart.setOption({
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        legend: {
                            data: ['正面', '中立', '负面'],
                            textStyle: { color: '#fff' },
                            top: 0
                        },
                        grid: { top: '15%', bottom: '10%', left: '15%', right: '5%' },
                        xAxis: {
                            type: 'value',
                            axisLine: { lineStyle: { color: '#00f6ff' } },
                            axisLabel: { color: '#fff', formatter: '{value}%' },
                            splitLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
                        },
                        yAxis: {
                            type: 'category',
                            data: data.sentiment_data.rooms,
                            axisLine: { lineStyle: { color: '#00f6ff' } },
                            axisLabel: { color: '#fff', interval: 0, rotate: 30 }
                        },
                        series: [
                            {
                                name: '正面',
                                type: 'bar',
                                stack: 'total',
                                label: { show: false },
                                emphasis: { focus: 'series' },
                                data: data.sentiment_data.positive,
                                itemStyle: { color: '#91cc75' }
                            },
                            {
                                name: '中立',
                                type: 'bar',
                                stack: 'total',
                                label: { show: false },
                                emphasis: { focus: 'series' },
                                data: data.sentiment_data.neutral,
                                itemStyle: { color: '#fac858' }
                            },
                            {
                                name: '负面',
                                type: 'bar',
                                stack: 'total',
                                label: { show: false },
                                emphasis: { focus: 'series' },
                                data: data.sentiment_data.negative,
                                itemStyle: { color: '#ee6666' }
                            }
                        ]
                    });
                }
                
                // Update Trajectory Chart (Mock User Movement)
                if (trajectoryChart && data.active_rooms.length > 0) {
                    const rooms = data.active_rooms.map(r => r.name);
                    
                    // Fixed Pentagon Layout (normalized 0-100)
                    const layouts = [
                        [50, 90], [90, 60], [75, 20], [25, 20], [10, 60]
                    ];
                    
                    const nodes = rooms.map((name, i) => ({
                        name: name,
                        x: layouts[i % 5][0],
                        y: layouts[i % 5][1],
                        symbolSize: 40,
                        itemStyle: { 
                            color: new echarts.graphic.RadialGradient(0.5, 0.5, 0.5, [
                                { offset: 0, color: '#00f6ff' },
                                { offset: 1, color: '#0b122e' }
                            ]),
                            borderColor: '#00f6ff',
                            borderWidth: 2
                        },
                        label: { show: true, position: 'bottom', color: '#fff', fontSize: 10 }
                    }));
                    
                    // Update static nodes only if not initialized or changed
                    // (Simplification: Update every time is fine)
                    trajectoryChart.setOption({
                        backgroundColor: 'transparent',
                        xAxis: { show: false, min: 0, max: 100 },
                        yAxis: { show: false, min: 0, max: 100 },
                        grid: { top: 0, bottom: 0, left: 0, right: 0 },
                        series: [{
                            name: 'Rooms',
                            type: 'graph',
                            layout: 'none',
                            coordinateSystem: 'cartesian2d',
                            data: nodes,
                            symbol: 'circle',
                            z: 2
                        }]
                    });
                    
                    // Start Simulation Logic
                    if (!trajectoryTimer) {
                        const runSimulation = () => {
                            if (nodes.length < 2) return;
                            
                            // Pick random path
                            const startIdx = Math.floor(Math.random() * nodes.length);
                            let endIdx = Math.floor(Math.random() * nodes.length);
                            while (endIdx === startIdx) {
                                endIdx = Math.floor(Math.random() * nodes.length);
                            }
                            
                            const startNode = nodes[startIdx];
                            const endNode = nodes[endIdx];
                            
                            trajectoryChart.setOption({
                                series: [
                                    {
                                        // Update Room Nodes (keep them)
                                        name: 'Rooms',
                                        data: nodes
                                    },
                                    {
                                        name: 'Path',
                                        type: 'lines',
                                        coordinateSystem: 'cartesian2d',
                                        z: 1,
                                        effect: {
                                            show: true,
                                            period: 2, // Speed of travel
                                            trailLength: 0.4,
                                            symbol: 'pin', // The "Virtual Person"
                                            symbolSize: 20,
                                            color: '#ffeb7b',
                                            loop: true // Keep moving to ensure visibility
                                        },
                                        lineStyle: {
                                            color: 'rgba(255, 255, 255, 0.2)',
                                            width: 1,
                                            curveness: 0.3
                                        },
                                        data: [{
                                            coords: [[startNode.x, startNode.y], [endNode.x, endNode.y]]
                                        }]
                                    }
                                ]
                            });
                        };
                        
                        runSimulation(); // Run immediately
                        trajectoryTimer = setInterval(runSimulation, 3000); // Change path every 3s
                    }
                }

                // Update Warnings
                const warningsContainer = document.getElementById('warning-list');
                warningsContainer.innerHTML = '';
                if (data.warnings.length === 0) {
                    warningsContainer.innerHTML = '<div class="warning-item" style="color: #00ff00;">暂无异常预警</div>';
                } else {
                    data.warnings.forEach(w => {
                        const div = document.createElement('div');
                        div.className = 'warning-item';
                        div.innerHTML = `<span class="time">[${w.time}]</span> ${w.user} 在房间 ${w.room}: ${w.content}`;
                        warningsContainer.appendChild(div);
                    });
                }
            })
            .catch(err => console.error(err));
    }

    // Init load and poll
    fetchData();
    setInterval(fetchData, 5000); // Refresh every 5s

    // ================= Focus Monitor Logic =================
    const searchInput = document.getElementById('monitor-search');
    const searchResults = document.getElementById('search-results');
    const monitorContent = document.getElementById('monitor-content');
    let monitorChart = null;
    let searchTimer = null;

    searchInput.addEventListener('input', function() {
        const q = this.value.trim();
        if (searchTimer) clearTimeout(searchTimer);
        
        if (!q) {
            searchResults.style.display = 'none';
            return;
        }
        
        searchTimer = setTimeout(() => {
            fetch(`{{ url_for('admin.monitor_search') }}?q=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.length === 0) {
                        searchResults.innerHTML = '<div style="padding:10px; color:#aaa;">无搜索结果</div>';
                    } else {
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.style.padding = '8px 10px';
                            div.style.cursor = 'pointer';
                            div.style.borderBottom = '1px solid #333';
                            div.innerHTML = item.label;
                            div.onmouseover = () => div.style.background = '#1a3c75';
                            div.onmouseout = () => div.style.background = 'transparent';
                            div.onclick = () => loadMonitorData(item.type, item.id);
                            searchResults.appendChild(div);
                        });
                    }
                    searchResults.style.display = 'block';
                });
        }, 500);
    });
    
    // Hide search results on click outside
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    function loadMonitorData(type, id) {
        searchResults.style.display = 'none';
        monitorContent.innerHTML = '<div style="text-align:center; padding:20px;"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 加载中...</div>';
        
        fetch(`{{ url_for('admin.monitor_data') }}?type=${type}&id=${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    monitorContent.innerHTML = `<div style="color:red;">加载失败: ${data.error}</div>`;
                    return;
                }
                
                if (type === 'user') {
                    renderUserMonitor(data);
                } else {
                    renderRoomMonitor(data);
                }
            })
            .catch(err => {
                console.error(err);
                monitorContent.innerHTML = '<div style="color:red;">网络错误</div>';
            });
    }

    function renderUserMonitor(data) {
        let msgsHtml = '';
        if (data.recent_msgs && data.recent_msgs.length > 0) {
            msgsHtml = data.recent_msgs.map(m => `
                <div style="margin-bottom:5px; font-size:12px; border-bottom:1px dashed #333; padding-bottom:3px;">
                    <span style="color:#00f6ff;">[${m.time}]</span> 
                    <span style="color:#aaa;">@${m.room}:</span> 
                    ${m.content}
                </div>
            `).join('');
        } else {
            msgsHtml = '<div style="color:#666;">暂无近期消息</div>';
        }

        const roomsHtml = data.active_rooms.map(r => `<span style="display:inline-block; padding:2px 6px; background:#1a3c75; margin:2px; border-radius:3px; font-size:12px;">${r}</span>`).join('');

        const html = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div style="font-size:18px; color:#00f6ff; font-weight:bold;">${data.name}</div>
                <div>
                    <span style="color:${data.status === '在线' ? '#00ff00' : '#aaa'}; font-weight:bold;">● ${data.status}</span>
                </div>
            </div>
            <div style="display:flex; margin-bottom:10px;">
                <div style="flex:1; text-align:center; border-right:1px solid #333;">
                    <div style="color:#aaa; font-size:12px;">发信总数</div>
                    <div style="font-size:16px; color:#fff;">${data.msg_count}</div>
                </div>
                <div style="flex:1; text-align:center;">
                    <div style="color:#aaa; font-size:12px;">社交活跃分</div>
                    <div style="font-size:16px; color:#ffeb7b;">${data.social_score}</div>
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <div style="color:#00f6ff; font-size:14px; margin-bottom:5px;">活跃群组</div>
                <div>${roomsHtml || '<span style="color:#666">无</span>'}</div>
            </div>
            <div>
                <div style="color:#00f6ff; font-size:14px; margin-bottom:5px;">最近发言</div>
                <div style="max-height:100px; overflow-y:auto;">${msgsHtml}</div>
            </div>
        `;
        monitorContent.innerHTML = html;
        if (monitorChart) {
            monitorChart.dispose();
            monitorChart = null;
        }
    }

    function renderRoomMonitor(data) {
        const html = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div style="font-size:18px; color:#00f6ff; font-weight:bold;">${data.name}</div>
                <div style="font-size:12px; color:#aaa;">在线: <span style="color:#00ff00;">${data.online_members}</span> / 总数: ${data.total_members}</div>
            </div>
            <div style="height:200px; width:100%;" id="monitor-chart"></div>
        `;
        monitorContent.innerHTML = html;
        
        // Render Social Graph
        setTimeout(() => {
            const chartDom = document.getElementById('monitor-chart');
            if (chartDom) {
                if (monitorChart) monitorChart.dispose();
                monitorChart = echarts.init(chartDom);
                
                monitorChart.setOption({
                    title: { text: '群社交关系 (Top 5)', textStyle: { color: '#fff', fontSize: 12 }, left: 'center' },
                    tooltip: {},
                    series: [
                        {
                            type: 'graph',
                            layout: 'force',
                            symbolSize: 30,
                            roam: true,
                            label: { show: true, position: 'bottom', color: '#fff' },
                            force: { repulsion: 100 },
                            data: data.nodes.map(n => ({
                                name: n.name,
                                value: n.value,
                                itemStyle: { color: '#00f6ff' }
                            })),
                            links: data.links,
                            lineStyle: { color: '#fff', opacity: 0.5 }
                        }
                    ]
                });
            }
        }, 100);
    }

    // ================= Real-time Activity Monitor =================
    let activityMonitorTimer = null;

    function fetchActivities() {
        fetch("{{ url_for('admin.monitor_activities') }}")
            .then(response => response.json())
            .then(data => {
                const activityMonitor = document.getElementById('activity-monitor');
                if (!activityMonitor) return;
                
                if (data.length === 0) {
                    activityMonitor.innerHTML = '<div style="text-align: center; color: #666; padding-top: 50px;">暂无活动数据</div>';
                    return;
                }

                let html = '';
                data.forEach(log => {
                    const actionColorMap = {
                        'login': '#00ff00',   // Green
                        'logout': '#aaa',     // Grey
                        'join_room': '#00f6ff', // Cyan
                        'leave_room': '#ff9900', // Orange
                        'chat': '#ffeb7b'     // Yellow
                    };
                    
                    html += `
                        <div style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #888; font-size: 12px; margin-right: 8px;">[${log.time}]</span>
                            <span style="color: #fff; font-weight: bold; margin-right: 5px;">${log.username}</span>
                            <span style="color: ${actionColorMap[log.action] || '#fff'}; margin-right: 5px;">${log.action_display}</span>
                            <span style="color: #ddd;">${log.content}</span>
                        </div>
                    `;
                });
                activityMonitor.innerHTML = html;
            })
            .catch(err => {
                console.error('Error fetching activities:', err);
            });
    }

    // Start polling
    if (activityMonitorTimer) clearInterval(activityMonitorTimer);
    activityMonitorTimer = setInterval(fetchActivities, 3000); // Poll every 3 seconds
    fetchActivities();
</script>
{% endblock %}
