{% extends "admin/layout.html" %}

{% block breadcrumb %}系统管理 / 角色管理{% endblock %}

{% block content %}
<div class="layui-card page-toolbar">
    <div class="layui-row">
        <div class="layui-col-md12">
            <button class="layui-btn layui-btn-normal" id="btn-add">
                <i class="layui-icon layui-icon-add-1"></i> 新增角色
            </button>
        </div>
    </div>
</div>

<div class="layui-card">
    <div class="layui-card-body">
        <table class="layui-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>角色名称</th>
                    <th>关联菜单数</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for role in roles %}
                <tr>
                    <td>{{ role.id }}</td>
                    <td>{{ role.name }}</td>
                    <td>
                        <span class="layui-badge layui-bg-gray">{{ role.menus|length }}</span>
                        {% if role.menus %}
                        <span class="layui-badge-rim btn-view-menus" 
                              title="点击查看关联菜单" 
                              style="cursor: pointer;"
                              data-menus='[{% for m in role.menus %}{"id": {{ m.id }}, "name": {{ m.name|tojson }}}{% if not loop.last %},{% endif %}{% endfor %}]'>
                            查看关联菜单
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="layui-btn layui-btn-xs layui-btn-normal btn-edit" data-id="{{ role.id }}">编辑/权限</button>
                        <button class="layui-btn layui-btn-xs layui-btn-danger btn-delete" data-id="{{ role.id }}">删除</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Form Modal -->
<div id="roleForm" style="display: none; padding: 20px;">
    <form class="layui-form" lay-filter="roleForm">
        <div class="layui-form-item">
            <label class="layui-form-label">角色名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" required lay-verify="required" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea name="description" class="layui-textarea"></textarea>
            </div>
        </div>
        
        <div class="layui-form-item">
            <label class="layui-form-label">菜单权限</label>
            <div class="layui-input-block">
                <div id="menu-tree" style="padding-top: 5px;">
                    {% for menu in all_menus %}
                        {% if menu.parent_id == None %}
                            <div style="margin-bottom: 5px;">
                                <input type="checkbox" name="menu_ids[]" value="{{ menu.id }}" title="{{ menu.name }}" lay-skin="primary">
                                {% if menu.children|length > 0 %}
                                    <div style="margin-left: 20px; margin-top: 5px; margin-bottom: 5px; border-left: 1px solid #eee; padding-left: 10px;">
                                        {% for child in menu.children %}
                                        <input type="checkbox" name="menu_ids[]" value="{{ child.id }}" title="{{ child.name }}" lay-skin="primary">
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="layui-form-item" style="text-align: center;">
            <button class="layui-btn" lay-submit lay-filter="submitRole">提交</button>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
layui.use(['layer', 'form'], function(){
    var layer = layui.layer;
    var form = layui.form;
    var $ = layui.$;
    
    // View Menus
    $('.btn-view-menus').click(function(){
        var menus = $(this).data('menus');
        var content = '<ul class="layui-timeline" style="padding: 20px;">';
        
        // Simple list or structured? Let's just list names for now
        // Or reconstruct hierarchy if possible, but flat list is safer
        menus.forEach(function(m){
             content += '<li class="layui-timeline-item"><i class="layui-icon layui-timeline-axis"></i><div class="layui-timeline-content layui-text"><h3 class="layui-timeline-title">' + m.name + '</h3></div></li>';
        });
        content += '</ul>';
        
        layer.open({
            type: 1,
            title: '关联菜单列表',
            area: ['400px', '500px'],
            content: content,
            shadeClose: true
        });
    });

    // Unified Submit Handler
    form.on('submit(submitRole)', function(data){
        var $form = $(data.form);
        var menu_ids = [];
        // Scope search to the current form to ensure we get the right checkboxes
        $form.find('#menu-tree input[type="checkbox"]:checked').each(function(){
            menu_ids.push($(this).val());
        });
        
        // Use .attr() to retrieve the url reliably
        var url = $form.attr('data-url');
        if(!url) {
            layer.msg('Configuration Error: No Submit URL found', {icon: 2});
            return false;
        }
        
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                name: $form.find('input[name="name"]').val(),
                description: $form.find('textarea[name="description"]').val(),
                menu_ids: menu_ids
            }),
            success: function(res){
                if(res.status === 'success'){
                    layer.msg(res.message, {icon: 1, time: 1000}, function(){
                        layer.closeAll();
                        location.reload();
                    });
                } else {
                    layer.msg(res.message, {icon: 2});
                }
            },
            error: function(xhr){
                var msg = 'Operation Failed';
                if(xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                layer.msg(msg, {icon: 2});
            }
        });
        return false;
    });

    // Add
    $('#btn-add').click(function(){
        // Reset form
        $('form[lay-filter="roleForm"]')[0].reset();
        $('form[lay-filter="roleForm"] input[type="hidden"]').val('');
        $('form[lay-filter="roleForm"] input[type="checkbox"]').prop('checked', false);
        
        // Set URL using .attr() for robustness
        $('form[lay-filter="roleForm"]').attr('data-url', '/admin/roles/add');
        
        layer.open({
            type: 1,
            title: '新增角色',
            area: ['600px', '600px'],
            content: $('#roleForm'),
            success: function(layero, index){
                form.render();
            }
        });
    });
    
    // Edit
    $('.btn-edit').click(function(){
        var id = $(this).data('id');
        
        // Reset form first
        $('form[lay-filter="roleForm"]')[0].reset();
        $('form[lay-filter="roleForm"] input[type="checkbox"]').prop('checked', false);
        
        // Set URL using .attr()
        $('form[lay-filter="roleForm"]').attr('data-url', '/admin/roles/' + id + '/edit');

        $.get('/admin/roles/' + id, function(res){
            // The backend returns the role object directly, not wrapped in status/message
            if(res && res.id){
                $('form[lay-filter="roleForm"] input[name="name"]').val(res.name);
                $('form[lay-filter="roleForm"] textarea[name="description"]').val(res.description);
                
                // Check assigned menus
                if(res.menu_ids){
                    res.menu_ids.forEach(function(mid){
                        $('form[lay-filter="roleForm"] input[value="' + mid + '"]').prop('checked', true);
                    });
                }
                
                layer.open({
                    type: 1,
                    title: '编辑角色',
                    area: ['600px', '600px'],
                    content: $('#roleForm'),
                    success: function(layero, index){
                        form.render();
                    }
                });
            } else {
                layer.msg('Failed to load role data', {icon: 2});
            }
        }).fail(function(){
             layer.msg('Failed to load role data', {icon: 2});
        });
    });
    
    // Delete
    $('.btn-delete').click(function(){
        var id = $(this).data('id');
        layer.confirm('确定删除该角色吗？', {icon: 3, title:'提示'}, function(index){
            $.post('/admin/roles/' + id + '/delete', function(res){
                if(res.status === 'success'){
                    layer.msg(res.message);
                    setTimeout(function(){ location.reload(); }, 1000);
                } else {
                    layer.msg(res.message, {icon: 2});
                }
            });
            layer.close(index);
        });
    });
});
</script>
{% endblock %}
