<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智联星队Chat - {{ server }}</title>
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/fontawesome/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='css/style.css') }}">
    <script src="{{ url_for('chat.static', filename='vendor/jquery/jquery-3.5.1.min.js') }}"></script>
</head>
<body>
    <div class="chat-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <i class="fas fa-search"></i> 搜索
                </div>
                <a href="{{ url_for('chat.logout') }}" style="color: #8b949e; cursor:pointer; text-decoration: none;" title="退出">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            
            <div class="chat-list">
                <!-- Static list for now, could be dynamic -->
                <div class="chat-item active">
                    <div class="avatar"><i class="fas fa-users"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">{{ server }}</div>
                        <div class="chat-preview">当前所在房间</div>
                    </div>
                </div>
                <div class="chat-item">
                    <div class="avatar" style="background: #1f6feb;"><i class="fas fa-bullhorn"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">系统公告</div>
                        <div class="chat-preview">欢迎来到智联星队Chat...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat -->
        <div class="main-chat">
            <div class="chat-top-bar">
                <div style="font-weight: bold;">{{ server }}</div>
                <div>
                    <i class="fas fa-ellipsis-h" style="color: #8b949e; cursor: pointer;"></i>
                </div>
            </div>
            
            <div class="message-area" id="messageArea">
                <!-- Messages will be injected here -->
                <div class="system-message">正在连接服务器...</div>
            </div>
            
            <div class="input-area">
                <div class="toolbar">
                    <i class="far fa-smile"></i>
                    <i class="far fa-folder"></i>
                    <i class="fas fa-cut"></i>
                    <i class="far fa-comment-dots"></i>
                </div>
                <textarea class="input-box" id="messageInput" placeholder="输入消息..."></textarea>
                <div style="text-align: right; margin-top: 5px;">
                    <button class="btn-login" id="sendBtn" style="width: auto; padding: 5px 20px; font-size: 14px;">发送</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const user = "{{ user }}";
        const room = "{{ server }}";
        // Construct WS URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/chat/ws`;
        
        let ws;

        function connect() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log("Connected");
                $('.system-message').last().text('已连接到服务器');
                // Send join message
                ws.send(JSON.stringify({
                    type: 'join',
                    user: user,
                    room: room
                }));
            };
            
            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                appendMessage(msg);
            };
            
            ws.onclose = function() {
                console.log("Disconnected");
                appendMessage({type: 'system', content: '连接断开，正在重连...', timestamp: ''});
                setTimeout(connect, 3000); // Reconnect
            };
            
            ws.onerror = function(err) {
                console.error("WS Error", err);
            };
        }
        
        connect();
        
        function appendMessage(msg) {
            const area = $('#messageArea');
            let html = '';
            
            if (msg.type === 'system') {
                html = `<div class="system-message">${msg.content} <span style="font-size:10px;">${msg.timestamp}</span></div>`;
            } else if (msg.type === 'chat') {
                const isSelf = msg.user === user;
                const cls = isSelf ? 'self' : 'other';
                const avatar = isSelf ? user[0].toUpperCase() : (msg.user ? msg.user[0].toUpperCase() : '?');
                
                html = `
                    <div class="message ${cls}">
                        <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: ${isSelf ? '#1f6feb' : '#238636'}">${avatar}</div>
                        <div>
                            <div class="message-meta" style="text-align: ${isSelf ? 'right' : 'left'}">${isSelf ? '' : msg.user}</div>
                            <div class="message-content">
                                ${msg.content}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
        }
        
        $('#sendBtn').click(sendMessage);
        $('#messageInput').keypress(function(e) {
            if (e.which == 13 && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        function sendMessage() {
            const input = $('#messageInput');
            const content = input.val().trim();
            if (content && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    content: content
                }));
                input.val('');
            }
        }
    </script>
</body>
</html>