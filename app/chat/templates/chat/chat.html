<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºè”æ˜Ÿé˜ŸChat - {{ server }}</title>
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/fontawesome/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='css/style.css') }}">
    <script src="{{ url_for('chat.static', filename='vendor/jquery/jquery-3.5.1.min.js') }}"></script>
</head>
<body>
    <div class="chat-wrapper">
        <!-- Main Sidebar (Leftmost) -->
        <div class="main-sidebar">
            <div class="main-nav-item active" title="èŠå¤©" onclick="switchTab(this, 'chat')">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div class="main-nav-item" title="å¥½å‹" onclick="switchTab(this, 'friend')">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="main-nav-item" title="æ¸¸æˆ" onclick="switchTab(this, 'game')">
                <i class="fas fa-gamepad"></i>
            </div>
            <div class="main-nav-item" title="ä¸ªäºº" onclick="switchTab(this, 'profile')">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="main-nav-item" title="è®¾ç½®" style="margin-top: auto;" onclick="switchTab(this, 'settings')">
                <i class="fas fa-cog"></i>
            </div>
            <a href="{{ url_for('chat.logout') }}" class="main-nav-item" title="é€€å‡º" style="text-decoration: none;">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>

        <!-- Sidebar (Chat List) -->
        <div class="sidebar" id="chatSidebar">
            <div class="sidebar-header" style="display: flex; align-items: center; gap: 10px; position: relative;">
                <div class="search-box" style="flex: 1; height: 36px; padding: 8px 12px; border-radius: 8px; font-size: 14px; display: flex; align-items: center; gap: 8px; background: #161b22; border: 1px solid #30363d;">
                    <i class="fas fa-search"></i> æœç´¢
                </div>
                <div class="add-action-btn" onclick="toggleAddMenu(this, event)">
                    <i class="fas fa-plus"></i>
                </div>
                <!-- Dropdown Menu -->
                <div class="add-menu-dropdown">
                    <div class="add-menu-item" onclick="createGroupDirect()">
                        <i class="fas fa-users-cog"></i> åˆ›å»ºç¾¤èŠ
                    </div>
                    <div class="add-menu-item" onclick="addFriendOrGroup()">
                        <i class="fas fa-user-plus"></i> åŠ å¥½å‹/ç¾¤
                    </div>
                </div>
            </div>
            
            <div class="chat-list">
                <!-- Static list for now, could be dynamic -->
                <div class="chat-item active">
                    <div class="avatar"><i class="fas fa-users"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">{{ server }}</div>
                        <div class="chat-preview">å½“å‰æ‰€åœ¨æˆ¿é—´</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sidebar (Contacts) -->
        <div class="sidebar" id="contactsSidebar" style="display: none;">
            <div class="sidebar-header" style="display: flex; align-items: center; gap: 10px; position: relative;">
                <div class="search-box" style="flex: 1; height: 36px; padding: 8px 12px; border-radius: 8px; font-size: 14px; display: flex; align-items: center; gap: 8px; background: #161b22; border: 1px solid #30363d;">
                    <i class="fas fa-search"></i> æœç´¢
                </div>
                <div class="add-action-btn" onclick="toggleAddMenu(this, event)">
                    <i class="fas fa-plus"></i>
                </div>
                <!-- Dropdown Menu -->
                <div class="add-menu-dropdown">
                    <div class="add-menu-item" onclick="createGroupDirect()">
                        <i class="fas fa-users-cog"></i> åˆ›å»ºç¾¤èŠ
                    </div>
                    <div class="add-menu-item" onclick="addFriendOrGroup()">
                        <i class="fas fa-user-plus"></i> åŠ å¥½å‹/ç¾¤
                    </div>
                </div>
            </div>
            
            <div class="contact-nav-list">
                <div class="contact-nav-item" onclick="showFriendNotifications()" style="cursor: pointer; padding: 12px 16px; font-size: 14px; display: flex; align-items: center; justify-content: space-between; background: #161b22; border: 1px solid #30363d; border-radius: 8px; margin: 10px 12px;">
                    <span>å¥½å‹é€šçŸ¥</span>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="contact-nav-item" style="padding: 12px 16px; font-size: 14px; display: flex; align-items: center; justify-content: space-between; background: #161b22; border: 1px solid #30363d; border-radius: 8px; margin: 10px 12px;">
                    <span>ç¾¤é€šçŸ¥</span>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="contact-tabs">
                <div class="contact-tab active" onclick="switchContactTab('friend')">å¥½å‹</div>
                <div class="contact-tab" onclick="switchContactTab('group')">ç¾¤èŠ</div>
            </div>

            <div class="contact-list" id="friendListPanel">
            </div>

            <div class="contact-list" id="groupListPanel" style="display: none;">
                <!-- Groups will be loaded dynamically -->
            </div>
        </div>

        <!-- Sidebar (Profile) -->
        <div class="sidebar" id="profileSidebar" style="display: none;">
             <div class="sidebar-header">
                <div style="font-weight: bold; font-size: 18px;">ä¸ªäººä¿¡æ¯</div>
            </div>
            <div class="profile-container" style="padding: 20px; display: flex; flex-direction: column; align-items: center;">
                <div class="profile-avatar" style="margin-bottom: 20px;">
                    {% if avatar %}
                    <img src="{{ avatar }}" class="avatar-img-large" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
                    {% else %}
                    <i class="fas fa-user-circle" style="font-size: 80px; color: #58a6ff;"></i>
                    {% endif %}
                </div>
                <div class="profile-info-item" style="width: 100%; margin-bottom: 15px; padding: 10px; background: #21262d; border-radius: 6px;">
                    <div class="label" style="font-size: 14px; color: #e6edf3; margin-bottom: 5px; font-weight: bold;">æ˜µç§°</div>
                    <div class="value" style="font-size: 16px; color: #c9d1d9;">{{ user }}</div>
                </div>
                <div class="profile-info-item" style="width: 100%; margin-bottom: 15px; padding: 10px; background: #21262d; border-radius: 6px;">
                    <div class="label" style="font-size: 14px; color: #e6edf3; margin-bottom: 5px; font-weight: bold;">è´¦å·</div>
                    <div class="value" style="font-size: 16px; color: #c9d1d9;">{{ username }}</div>
                </div>
                <div style="margin-top: 20px; width: 100%;">
                    <button class="btn-login" onclick="openEditProfile()" style="width: 100%;">ä¿®æ”¹ä¿¡æ¯</button>
                </div>
            </div>
        </div>

        <!-- Sidebar (Settings) -->
        <div class="sidebar" id="settingsSidebar" style="display: none;">
            <div class="sidebar-header">
                <div style="font-weight: bold; font-size: 18px;">è®¾ç½®</div>
            </div>
            <div class="settings-list">
                <div class="setting-item">
                    <span class="setting-label">æ–°æ¶ˆæ¯æç¤ºéŸ³</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleMsgSound" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">å¥½å‹ä¸Šçº¿æç¤ºéŸ³</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleUserSound" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">å‘é€æ¶ˆæ¯æç¤ºéŸ³</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleSelfSound" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Edit Profile Sidebar -->
        <div class="sidebar" id="editProfileSidebar" style="display: none; z-index: 1002; position: absolute; left: 311px; top: 0; bottom: 0; box-shadow: 4px 0 24px rgba(0,0,0,0.5);">
            <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: bold; font-size: 18px;">ä¿®æ”¹ä¿¡æ¯</div>
                <i class="fas fa-times close-sidebar" onclick="closeEditProfile()"></i>
            </div>
            <div class="profile-container" style="padding: 20px; display: flex; flex-direction: column; align-items: center;">
                <div class="profile-avatar-edit" onclick="document.getElementById('avatarUpload').click()" style="position: relative; cursor: pointer; margin-bottom: 20px;">
                    {% if avatar %}
                    <img id="avatarPreview" src="{{ avatar }}" style="display: block; width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
                    <i id="avatarPlaceholder" class="fas fa-camera" style="display: none; font-size: 40px; color: #8b949e; background: #21262d; padding: 20px; border-radius: 50%;"></i>
                    {% else %}
                    <img id="avatarPreview" src="" style="display: none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
                    <i id="avatarPlaceholder" class="fas fa-camera" style="display: block; font-size: 40px; color: #8b949e; background: #21262d; padding: 20px; border-radius: 50%;"></i>
                    {% endif %}
                    <div class="avatar-overlay" style="position: absolute; bottom: 0; right: 0; background: #58a6ff; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-pen" style="font-size: 12px; color: white;"></i>
                    </div>
                </div>
                <input type="file" id="avatarUpload" style="display: none;" accept="image/*" onchange="previewAvatar(this)">
                
                <div class="form-group" style="width: 100%; margin-top: 20px;">
                    <label style="color: #8b949e; margin-bottom: 5px; display: block;">æ˜µç§°</label>
                    <input type="text" id="editNickname" class="input-box" value="{{ user }}" style="background: #0d1117; border: 1px solid #30363d; padding: 10px; height: 40px; border-radius: 6px; width: 100%; color: #ffffff; font-size: 16px; font-weight: bold;">
                </div>
                
                <button class="btn-login" onclick="saveProfile()" style="margin-top: 30px; width: 100%;">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
        
        <!-- Main Chat -->
        <div class="main-chat">
            <!-- Friend Profile Modal (Overlay) -->
            <div id="friendProfileModal" class="friend-profile-modal" style="display: none;">
                <div class="friend-profile-content" style="position: relative;">
                    <i class="fas fa-times" onclick="$('#friendProfileModal').hide(); $('#chatMainContent').css('display', 'flex');" style="position: absolute; top: 15px; right: 15px; cursor: pointer; color: #8b949e; font-size: 18px;"></i>
                    <div class="fp-header">
                        <div class="fp-avatar" id="fpAvatarContainer">
                            <!-- Injected by JS -->
                        </div>
                        <div class="fp-info">
                            <div class="fp-name" id="fpNickname"></div>
                            <div class="fp-id" id="fpUsername"></div>
                            <div class="fp-status">
                                <span class="status-dot offline" id="fpStatusDot"></span> 
                                <span id="fpStatusText">ç¦»çº¿</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="width: 100%; margin-bottom: 25px; padding: 15px; background: #161b22; border-radius: 8px; border: 1px solid #30363d;">
                        <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">å¤‡æ³¨å</div>
                        <div id="fpRemark" style="color: #e6edf3; font-size: 14px; min-height: 20px;"></div>
                    </div>

                    <div class="fp-actions">
                        <button class="btn-primary" id="fpSendMsgBtn">
                            <i class="fas fa-comment-dots"></i> å‘æ¶ˆæ¯
                        </button>
                        <button style="background: #21262d; color: #c9d1d9; border: 1px solid #30363d;" onclick="openShareModal()">
                            <i class="fas fa-share-square"></i> åˆ†äº«åç‰‡
                        </button>
                    </div>
                </div>
            </div>

            <!-- Share Friend Modal -->
            <div id="shareModal" class="friend-profile-modal" style="display: none; z-index: 1100; background: rgba(1, 4, 9, 0.9);">
                <div class="friend-profile-content" style="width: 350px;">
                    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #e6edf3; font-size: 16px;">é€‰æ‹©åˆ†äº«å¯¹è±¡</h3>
                        <i class="fas fa-times" onclick="$('#shareModal').hide()" style="cursor: pointer; color: #8b949e;"></i>
                    </div>
                    <div id="shareList" style="width: 100%; height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #30363d; border-radius: 6px; background: #0d1117;">
                        <!-- List populated by JS -->
                    </div>
                </div>
            </div>

            <div id="friendNotificationsPanel" style="display: none; flex-direction: column; height: 100%; background: #0d1117;">
                <div class="chat-top-bar" style="border-bottom: 1px solid #30363d;">
                    <div style="font-weight: bold;">å¥½å‹é€šçŸ¥</div>
                </div>
                <div id="notificationsList" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <!-- Content injected by JS -->
                </div>
            </div>

            <div id="chatMainContent" style="display: flex; flex-direction: column; height: 100%;">
                <div class="chat-top-bar" style="height: auto; min-height: 50px; padding: 10px 20px;">
                <div style="display: flex; flex-direction: column; justify-content: center;">
                    <div style="font-weight: bold; font-size: 16px;" id="chatTitle">{{ server }}</div>
                    <div style="font-size: 12px; color: #8b949e; cursor: pointer; display: none; margin-top: 2px;" id="chatRoomIdContainer" onclick="copyRoomId()" title="ç‚¹å‡»å¤åˆ¶ç¾¤å·">
                        ç¾¤å·: <span id="currentRoomId"></span> <i class="far fa-copy" style="margin-left: 5px;"></i>
                    </div>
                </div>
                <div>
                    <i class="fas fa-ellipsis-h" style="color: #8b949e; cursor: pointer;" onclick="toggleUserSidebar()" title="åœ¨çº¿ç”¨æˆ·"></i>
                </div>
            </div>
            
            <div class="message-area" id="messageArea">
                <!-- Messages will be injected here -->
                <div class="system-message">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
            </div>
            
            <div class="input-area">
                <!-- Voice Input Panel -->
                <div class="voice-input-panel" id="voiceInputPanel" style="display: none;">
                    <div class="voice-timer" id="voiceTimer">0:00</div>
                    <div class="voice-icon-wrapper">
                        <div class="voice-ripple"></div>
                        <i class="fas fa-microphone" id="voiceMainIcon"></i>
                    </div>
                    <div class="voice-instruction" id="voiceInstruction">æŒ‰ä½ç©ºæ ¼é”®å¼€å§‹è¯´è¯ï¼ŒæŒ‰ Esc é”®æˆ–ç‚¹å‡»<span class="voice-action-link" onclick="exitVoiceMode()">é€€å‡º</span></div>
                </div>

                <!-- Emoji Panel -->
                <div class="emoji-panel" id="emojiPanel" style="display: none;">
                    <input type="file" id="stickerFileInput" style="display: none;" accept="image/png, image/jpeg, image/gif">
                    
                    <div class="emoji-body">
                        <div class="emoji-grid" id="emojiGrid"></div>
                        <div class="sticker-grid" id="stickerGrid" style="display: none;"></div>
                    </div>
                    <div class="emoji-footer">
                        <div class="emoji-tab active" title="Emoji" onclick="switchEmojiTab('emoji')">
                            <i class="far fa-smile"></i>
                        </div>
                        <div class="emoji-tab" title="Stickers" onclick="switchEmojiTab('sticker')">
                            <i class="fas fa-icons"></i>
                        </div>
                    </div>
                </div>

                <div class="toolbar" id="chatToolbar">
                    <i class="far fa-smile" id="emojiBtn" title="è¡¨æƒ…"></i>
                    <i class="far fa-folder" id="fileBtn" title="å‘é€æ–‡ä»¶"></i>
                    <input type="file" id="fileInput" style="display: none;">
                    <i class="fas fa-microphone" id="voiceBtn" title="è¯­éŸ³è¾“å…¥"></i>
                    <i class="far fa-comment-dots"></i>
                </div>
                <textarea class="input-box" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                <div style="text-align: right; margin-top: 5px;" id="sendBtnContainer">
                    <button class="btn-login" id="sendBtn" style="width: auto; padding: 5px 20px; font-size: 14px;">å‘é€</button>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- User Sidebar -->
    <div class="user-sidebar" id="userSidebar">
        <div class="user-sidebar-header">
            <span>åœ¨çº¿ç”¨æˆ·(<span id="userCount">0</span>)</span>
            <i class="fas fa-times close-sidebar" onclick="toggleUserSidebar()"></i>
        </div>
        <div class="user-list" id="userList">
            <!-- User items injected here -->
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="audioMsgComing" src="{{ url_for('chat.static', filename='mp3/msgcoming.mp3') }}" preload="auto"></audio>
    <audio id="audioUserComing" src="{{ url_for('chat.static', filename='mp3/usercoming.mp3') }}" preload="auto"></audio>
    <audio id="audioUserSendMsg" src="{{ url_for('chat.static', filename='mp3/usersendmsg.mp3') }}" preload="auto"></audio>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;">
        <div class="modal-content" style="background-color: #161b22; margin: auto; padding: 20px; border: 1px solid #30363d; width: 300px; border-radius: 6px; color: #c9d1d9;">
            <h3 style="margin-top: 0; font-size: 18px; border-bottom: 1px solid #30363d; padding-bottom: 10px; margin-bottom: 15px;">åˆ›å»ºç¾¤èŠ</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">ç¾¤èŠåç§°</label>
                <input type="text" id="newGroupName" class="input-box" style="width: 100%; background: #0d1117; border: 1px solid #30363d; color: #fff; padding: 8px; border-radius: 4px;" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°">
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn-login" style="background-color: #30363d; margin-right: 10px; border: none; padding: 6px 12px; border-radius: 4px; color: #c9d1d9; cursor: pointer;" onclick="closeCreateGroupModal()">å–æ¶ˆ</button>
                <button class="btn-login" style="background-color: #238636; border: none; padding: 6px 12px; border-radius: 4px; color: #fff; cursor: pointer;" onclick="confirmCreateGroupDirect()">åˆ›å»º</button>
            </div>
        </div>
    </div>




    <script>
        const currentUser = "{{ user }}";
        const currentUsername = "{{ username }}";
        const currentUserId = "{{ current_user_obj_id }}"; // Need to pass this from route or fetch
        let currentRoom = "{{ server }}";
        // Construct WS URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/chat/ws`;
        
        let ws;
        let previousUserList = new Set();
        let isFirstLoad = true;
        
        // Chat List Management
        let chatList = []; // Array of {id, name, type, avatar, roomId}


        function createGroupDirect() {
            $('.add-menu-dropdown').hide();
            $('#newGroupName').val('');
            $('#createGroupModal').css('display', 'flex');
        }

        function closeCreateGroupModal() {
            $('#createGroupModal').hide();
        }

        function confirmCreateGroupDirect() {
            const groupName = $('#newGroupName').val().trim();
            if (!groupName) {
                alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
                return;
            }
            
            $.ajax({
                url: "{{ url_for('chat.create_group') }}",
                type: 'POST',
                data: { name: groupName },
                success: function(response) {
                    if (response.success) {
                        closeCreateGroupModal();
                        alert('ç¾¤èŠåˆ›å»ºæˆåŠŸ');
                        if (typeof fetchChatList === 'function') {
                            fetchChatList();
                        } else {
                            location.reload(); 
                        }
                    } else {
                        alert('åˆ›å»ºå¤±è´¥: ' + response.message);
                    }
                },
                error: function() {
                    alert('æœåŠ¡å™¨é”™è¯¯');
                }
            });
        }

        const settings = {
            msgSound: localStorage.getItem('msgSound') !== 'false',
            userSound: localStorage.getItem('userSound') !== 'false',
            selfSound: localStorage.getItem('selfSound') !== 'false'
        };

        // Initialize checkboxes
        $('#toggleMsgSound').prop('checked', settings.msgSound);
        $('#toggleUserSound').prop('checked', settings.userSound);
        $('#toggleSelfSound').prop('checked', settings.selfSound);

        // Settings event listeners
        $('#toggleMsgSound').change(function() {
            settings.msgSound = this.checked;
            localStorage.setItem('msgSound', this.checked);
        });
        $('#toggleUserSound').change(function() {
            settings.userSound = this.checked;
            localStorage.setItem('userSound', this.checked);
        });
        $('#toggleSelfSound').change(function() {
            settings.selfSound = this.checked;
            localStorage.setItem('selfSound', this.checked);
        });

        function playSound(type) {
            let audioId = '';
            let shouldPlay = false;

            if (type === 'msg' && settings.msgSound) {
                audioId = 'audioMsgComing';
                shouldPlay = true;
            } else if (type === 'user' && settings.userSound) {
                audioId = 'audioUserComing';
                shouldPlay = true;
            } else if (type === 'self' && settings.selfSound) {
                audioId = 'audioUserSendMsg';
                shouldPlay = true;
            }

            if (shouldPlay && audioId) {
                const audio = document.getElementById(audioId);
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed:", e));
                }
            }
        }

        let currentlyPlaying = null;
        let currentAudio = null;

        function playVoice(element, url) {
            if (currentAudio) {
                // If another audio is playing, pause it and reset its icon
                if (currentAudio.src !== url) {
                    currentAudio.pause();
                    if (currentlyPlaying) {
                        currentlyPlaying.classList.remove('playing');
                    }
                }
            }

            const isPlaying = element.classList.contains('playing');

            if (isPlaying) {
                // Pause the current audio
                if (currentAudio) {
                    currentAudio.pause();
                }
                element.classList.remove('playing');
            } else {
                // Play the new audio
                if (!currentAudio || currentAudio.src !== url) {
                    currentAudio = new Audio(url);
                }
                
                currentAudio.play().then(() => {
                    // If there was a previously playing item, reset it
                    if (currentlyPlaying && currentlyPlaying !== element) {
                        currentlyPlaying.classList.remove('playing');
                    }
                    
                    element.classList.add('playing');
                    currentlyPlaying = element;

                    currentAudio.onended = () => {
                        element.classList.remove('playing');
                        currentlyPlaying = null;
                        currentAudio = null;
                    };
                }).catch(e => {
                    console.error("Audio play failed:", e);
                    // Clean up if play fails
                    if (currentlyPlaying) {
                        currentlyPlaying.classList.remove('playing');
                    }
                });
            }
        }

        function connect(roomName) {
            if (ws) {
                // Prevent recursive reconnect on intentional close
                ws.onclose = null;
                ws.close();
            }
            
            // Update current room global
            if (roomName) {
                currentRoom = roomName;
            }
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log("Connected to " + currentRoom);
                $('.system-message').last().text('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                // Send join message
                ws.send(JSON.stringify({
                    'type': 'join',
                    'user': currentUser,
                    'room': currentRoom
                }));
            };
            
            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                if (msg.type === 'users') {
                    updateUserList(msg.users, msg.count);
                } else if (msg.type === 'profile_update') {
                     // Update current user profile panel
                     if (msg.username === "{{ username }}") {
                         $('.profile-info-item .value').first().text(msg.nickname);
                         if (msg.avatar) {
                             if ($('.profile-avatar img').length > 0) {
                                 $('.profile-avatar img').attr('src', msg.avatar);
                             } else {
                                 $('.profile-avatar i').replaceWith('<img src="' + msg.avatar + '" class="avatar-img-large" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">');
                             }
                             $('#avatarPreview').attr('src', msg.avatar).show();
                             $('#avatarPlaceholder').hide();
                         }
                     }
                     
                     // Sync avatars in chat history for all users
                     if (msg.avatar) {
                        // Update existing images
                        $(`img.user-avatar-${msg.username}`).attr('src', msg.avatar);
                        
                        // Replace div placeholders with images
                        $(`div.user-avatar-${msg.username}`).each(function() {
                             const marginL = $(this).css('marginLeft');
                             const marginR = $(this).css('marginRight');
                             $(this).replaceWith(`<img src="${msg.avatar}" class="avatar-img user-avatar-${msg.username}" data-username="${msg.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-left: ${marginL}; margin-right: ${marginR};">`);
                        });
                     }
                } else {
                    appendMessage(msg);
                }
            };
            
            ws.onclose = function() {
                console.log("Disconnected");
                appendMessage({type: 'system', content: 'è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', timestamp: ''});
                setTimeout(connect, 3000); // Reconnect
            };
            
            ws.onerror = function(err) {
                console.error("WS Error", err);
            };
        }
        
        connect();
        
        function appendMessage(msg) {
            const area = $('#messageArea');
            let html = '';
            
            if (msg.type === 'system') {
                html = `<div class="system-message">${msg.content} <span style="font-size:10px;">${msg.timestamp}</span></div>`;
            } else if (msg.type === 'chat') {
                const isSelf = msg.user === currentUser;
                
                // Play sound
                if (isSelf) {
                    playSound('self');
                } else {
                    playSound('msg');
                }

                const cls = isSelf ? 'sent' : 'received';
                // const avatar = isSelf ? currentUser[0].toUpperCase() : (msg.user ? msg.user[0].toUpperCase() : '?');
                const msgUsername = isSelf ? "{{ username }}" : (msg.username || '');
                
                let avatarHtml;
                if (msg.avatar) {
                    avatarHtml = `<img src="${msg.avatar}" class="avatar-img user-avatar-${msgUsername}" data-username="${msgUsername}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 10px; margin-left: ${isSelf ? '10px' : '0'};">`;
                } else {
                    const initial = isSelf ? currentUser[0].toUpperCase() : (msg.user ? msg.user[0].toUpperCase() : '?');
                    const bg = isSelf ? '#1f6feb' : '#238636';
                    avatarHtml = `<div class="avatar user-avatar-${msgUsername}" data-username="${msgUsername}" style="width: 32px; height: 32px; font-size: 12px; background: ${bg}; margin-right: 10px; margin-left: ${isSelf ? '10px' : '0'};">${initial}</div>`;
                }
                
                // Handle Stickers
                let displayContent = msg.content;
                
                // Voice Message
                displayContent = displayContent.replace(/\[voice:([^|\]]+)\|([^\]]+)\]/g, function(match, url, duration) {
                    const wave = '..._._';
                    return `
                        <div class="chat-voice-message" onclick="playVoice(this, '${url}')">
                            <div class="chat-voice-icon">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="chat-voice-waveform">${wave}</div>
                            <div class="chat-voice-duration">${duration}"</div>
                        </div>`;
                });

                // Regex matches [sticker:URL] - Updated to support relative paths and legacy icons
                displayContent = displayContent.replace(/\[sticker:([^\]]+)\]/g, function(match, content) {
                    if (content.startsWith('http') || content.startsWith('/')) {
                        return '<img src="' + content + '" class="chat-sticker">';
                    } else if (content.startsWith('fa-')) {
                        return '<i class="fas ' + content + ' fa-3x" style="color: #58a6ff;"></i>';
                    }
                    return match;
                });

                // Regex matches [file:URL|FILENAME|SIZE]
                displayContent = displayContent.replace(/\[file:([^|\]]+)\|([^|\]]+)(?:\|([^\]]+))?\]/g, function(match, url, name, size) {
                    const fileSize = size || 'Unknown size';
                    const iconClass = getFileIcon(name);
                    return `
                        <div class="chat-file-card">
                            <div class="chat-file-icon">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="chat-file-info">
                                <div class="chat-file-name">${name}</div>
                                <div class="chat-file-size">${fileSize}</div>
                            </div>
                            <div class="chat-file-download" onclick="downloadFile('${url}', '${name}')" role="button">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>`;
                });

                html = `
                    <div class="message ${cls}">
                        ${avatarHtml}
                        <div>
                            <div class="message-meta" style="text-align: ${isSelf ? 'right' : 'left'}">${isSelf ? '' : msg.user}</div>
                            <div class="bubble">
                                ${displayContent}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
        }
        
        $('#sendBtn').click(sendMessage);
        $('#messageInput').keypress(function(e) {
            if (e.which == 13 && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        function sendMessage() {
            const input = $('#messageInput');
            const content = input.val().trim();
            if (content && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    content: content
                }));
                input.val('');
            }
        }
        
        function toggleUserSidebar() {
            $('.user-sidebar').toggleClass('active');
            if ($('.user-sidebar').hasClass('active')) {
                $('.settings-sidebar').removeClass('active');
            }
        }

        // Toggle Add Menu
        function toggleAddMenu(btn, event) {
            if (event) {
                event.stopPropagation();
            }
            const menu = $(btn).siblings('.add-menu-dropdown');
            
            // Close other open menus
            $('.add-menu-dropdown').not(menu).hide();
            
            if (menu.is(':hidden')) {
                menu.fadeIn(100);
            } else {
                menu.fadeOut(100);
            }
        }

        // Close menu when clicking outside
        $(document).click(function() {
            $('.add-menu-dropdown').fadeOut(100);
        });



        function switchTab(element, tabName) {
            // Remove active from all nav items
            $('.main-nav-item').removeClass('active');
            // Add active to clicked item
            $(element).addClass('active');

            // Hide edit profile sidebar
            if (typeof closeEditProfile === 'function') {
                closeEditProfile();
            } else {
                $('#editProfileSidebar').hide();
            }
            
            // Hide all sidebars first
            $('#chatSidebar').hide();
            $('#contactsSidebar').hide();
            $('#profileSidebar').hide();
            $('#settingsSidebar').hide();

            if (tabName === 'chat') {
                $('#chatSidebar').show();
            } else if (tabName === 'friend') {
                $('#contactsSidebar').show();
            } else if (tabName === 'settings') {
                $('#settingsSidebar').show();
                $('.user-sidebar').removeClass('active');
            } else if (tabName === 'profile') {
                $('#profileSidebar').show();
            }
        }

        function switchContactTab(tab) {
            $('.contact-tab').removeClass('active');
            if (tab === 'friend') {
                $('.contact-tab').eq(0).addClass('active');
                $('#friendListPanel').show();
                $('#groupListPanel').hide();
            } else {
                $('.contact-tab').eq(1).addClass('active');
                $('#friendListPanel').hide();
                $('#groupListPanel').show();
            }
        }

        function toggleCategory(header) {
            const content = $(header).next('.category-content');
            
            if (content.is(':visible')) {
                content.slideUp(200);
                $(header).removeClass('active');
            } else {
                content.slideDown(200);
                $(header).addClass('active');
            }
        }

        // closeSettingsSidebar removed

        function updateUserList(users, count) {
            $('#userCount').text(count);
            const list = $('#userList');
            list.empty();
            
            // Check for new users
            const currentUserSet = new Set(users);
            
            if (!isFirstLoad) {
                for (let u of currentUserSet) {
                    if (!previousUserList.has(u) && u !== currentUser) {
                        playSound('user');
                        break; // Play once per update batch
                    }
                }
            }
            
            previousUserList = currentUserSet;
            isFirstLoad = false;

            users.forEach(u => {
                const isSelf = u === currentUser;
                const html = `
                    <div class="user-item">
                        <div class="avatar" style="width: 30px; height: 30px; font-size: 12px; background: ${isSelf ? '#1f6feb' : '#238636'}">
                            ${u[0].toUpperCase()}
                        </div>
                        <div class="user-name" style="${isSelf ? 'color: #58a6ff;' : ''}">
                            ${u} ${isSelf ? '(æˆ‘)' : ''}
                        </div>
                    </div>
                `;
                list.append(html);
            });
        }

        // Emoji Logic
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const messageInput = document.getElementById('messageInput');
        
        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜',
            'ğŸ˜', 'ğŸ˜˜', 'ğŸ¥°', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤©', 'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜',
            'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´',
            'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²',
            'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©',
            'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬',
            'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¥³', 'ğŸ¥´', 'ğŸ¥º',
            'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ’€', 'ğŸ‘»', 'ğŸ‘½',
            'ğŸ¤–', 'ğŸ’©', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ‘‹',
            'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ',
            'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘',
            'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦µ', 'ğŸ¦¿',
            'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹'
        ];

        // Populate Emojis
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = emoji;
            span.onclick = function() {
                messageInput.value += emoji;
                messageInput.focus();
            };
            emojiGrid.appendChild(span);
        });

        // Switch Emoji Tab
        function switchEmojiTab(type) {
            $('.emoji-tab').removeClass('active');
            if (type === 'emoji') {
                $('.emoji-tab:first-child').addClass('active');
                $('#emojiGrid').show();
                $('#stickerGrid').hide();
            } else {
                $('.emoji-tab:last-child').addClass('active');
                $('#emojiGrid').hide();
                $('#stickerGrid').show();
            }
        }

        // Populate Stickers (User Custom)
        const stickerGrid = document.getElementById('stickerGrid');
        const stickerFileInput = document.getElementById('stickerFileInput');
        
        // Handle file selection
        stickerFileInput.onchange = function() {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            fetch('{{ url_for("chat.upload_sticker") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderStickers();
                } else {
                    alert(data.message || 'ä¸Šä¼ å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ä¸Šä¼ å‡ºé”™');
            })
            .finally(() => {
                // Clear input so same file can be selected again if needed
                stickerFileInput.value = '';
            });
        };

        function renderStickers() {
            // Keep the Add Button always visible/re-render it
            stickerGrid.innerHTML = '';

            // Add Button
            const addBtn = document.createElement('div');
            addBtn.className = 'sticker-item add-btn';
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.title = 'ä»æœ¬åœ°ä¸Šä¼ è¡¨æƒ…';
            addBtn.onclick = function(e) {
                e.stopPropagation();
                stickerFileInput.click();
            };
            stickerGrid.appendChild(addBtn);

            // Fetch stickers from server
            fetch('{{ url_for("chat.get_stickers") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stickers) {
                    data.stickers.forEach((sticker) => {
                        const div = document.createElement('div');
                        div.className = 'sticker-item';
                        div.innerHTML = `<img src="${sticker.url}" style="width: 100%; height: 100%; object-fit: contain;">`;
                        div.title = 'å³é”®ç‚¹å‡»å¯åˆ é™¤';
                        
                        div.onclick = function(e) {
                            e.stopPropagation(); // Prevent panel closing
                            if (ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({
                                    type: 'chat',
                                    content: `[sticker:${sticker.url}]`
                                }));
                                // Optional: Close panel after sending
                                emojiPanel.style.display = 'none';
                            }
                        };

                        // Right click to delete
                        div.oncontextmenu = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            if(confirm("æ˜¯å¦åˆ é™¤è¯¥è¡¨æƒ…?")) {
                                fetch('{{ url_for("chat.delete_sticker") }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ url: sticker.url })
                                })
                                .then(res => res.json())
                                .then(resData => {
                                    if (resData.success) {
                                        renderStickers();
                                    } else {
                                        alert(resData.message || "åˆ é™¤å¤±è´¥");
                                    }
                                })
                                .catch(err => console.error(err));
                            }
                        };
                        
                        stickerGrid.appendChild(div);
                    });
                }
            })
            .catch(err => console.error("Error fetching stickers:", err));
        }

        renderStickers();

        // Toggle Panel
        emojiBtn.onclick = function(e) {
            e.stopPropagation();
            if (emojiPanel.style.display === 'none') {
                emojiPanel.style.display = 'flex';
            } else {
                emojiPanel.style.display = 'none';
            }
        };

        // Close on click outside (Emoji Panel)
        document.addEventListener('click', function(e) {
            if (emojiPanel.style.display !== 'none' && !emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.style.display = 'none';
            }
        });

        // File Upload Logic
        const fileBtn = document.getElementById('fileBtn');
        const fileInput = document.getElementById('fileInput');

        fileBtn.onclick = function() {
            fileInput.click();
        };

        fileInput.onchange = function() {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            // Using the same upload endpoint for now, or create a new one for generic files
            // For simplicity, reusing upload_sticker but treating as generic file upload
            // Ideally, we should have a separate endpoint or flag
            fetch('{{ url_for("chat.upload_file") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (ws.readyState === WebSocket.OPEN) {
                        // Determine file type for display
                        const isImage = file.type.startsWith('image/');
                        const formattedSize = formatFileSize(file.size);
                        const content = isImage 
                            ? `[sticker:${data.url}]` // Reuse sticker format for images
                            : `[file:${data.url}|${file.name}|${formattedSize}]`; // New format for files
                        
                        ws.send(JSON.stringify({
                            type: 'chat',
                            content: content
                        }));
                    }
                } else {
                    alert(data.message || 'ä¸Šä¼ å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ä¸Šä¼ å‡ºé”™');
            })
            .finally(() => {
                fileInput.value = '';
            });
        };

        // Helper functions for File Display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch(ext) {
                case 'doc': case 'docx': return 'fa-file-word';
                case 'pdf': return 'fa-file-pdf';
                case 'xls': case 'xlsx': return 'fa-file-excel';
                case 'ppt': case 'pptx': return 'fa-file-powerpoint';
                case 'zip': case 'rar': case '7z': return 'fa-file-archive';
                case 'mp3': case 'wav': return 'fa-file-audio';
                case 'mp4': case 'avi': return 'fa-file-video';
                case 'txt': return 'fa-file-alt';
                case 'jpg': case 'jpeg': case 'png': case 'gif': return 'fa-file-image';
                default: return 'fa-file';
            }
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Close sidebars when clicking outside
        $(document).on('click', function(e) {
            // User Sidebar
            if ($('.user-sidebar').hasClass('active')) {
                if (!$(e.target).closest('.user-sidebar').length && !$(e.target).closest('.chat-top-bar .fa-ellipsis-h').length) {
                    $('.user-sidebar').removeClass('active');
                }
            }
            
            // Settings Sidebar logic removed
        });

        /* Voice Input Logic */
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let voiceStartTime;
        let voiceTimerInterval;
        let isVoiceMode = false;

        const voiceBtn = document.getElementById('voiceBtn');
        const voiceInputPanel = document.getElementById('voiceInputPanel');
        const chatToolbar = document.getElementById('chatToolbar');
        const sendBtnContainer = document.getElementById('sendBtnContainer');
        const voiceTimer = document.getElementById('voiceTimer');
        const voiceIconWrapper = document.querySelector('.voice-icon-wrapper');
        const voiceInstruction = document.getElementById('voiceInstruction');

        // Toggle Voice Mode
        voiceBtn.onclick = function() {
            enterVoiceMode();
        };

        function enterVoiceMode() {
            isVoiceMode = true;
            voiceInputPanel.style.display = 'flex';
            resetVoiceUI();
        }

        function exitVoiceMode() {
            isVoiceMode = false;
            if (isRecording) {
                cancelRecording();
            }
            voiceInputPanel.style.display = 'none';
        }

        function resetVoiceUI() {
            voiceTimer.classList.remove('active');
            voiceTimer.textContent = '0:00';
            voiceIconWrapper.classList.remove('active');
            voiceInstruction.innerHTML = 'æŒ‰ä½ç©ºæ ¼é”®å¼€å§‹è¯´è¯ï¼ŒæŒ‰ Esc é”®æˆ–ç‚¹å‡»<span class="voice-action-link" onclick="exitVoiceMode()">é€€å‡º</span>';
        }

        function setRecordingUI() {
            voiceTimer.classList.add('active');
            voiceIconWrapper.classList.add('active');
            voiceInstruction.innerHTML = 'æ¾æ‰‹å‘é€ï¼ŒæŒ‰ Esc é”®æˆ–ç‚¹å‡»<span class="voice-action-link" onclick="cancelRecording()">å–æ¶ˆå‘é€</span>';
        }

        // Space Key Handlers
        document.addEventListener('keydown', function(e) {
            if (!isVoiceMode) return;
            if (e.code === 'Space' && !isRecording && !e.repeat) {
                e.preventDefault(); // Prevent scrolling
                startRecording();
            }
            if (e.code === 'Escape') {
                if (isRecording) {
                    cancelRecording();
                } else {
                    exitVoiceMode();
                }
            }
        });

        document.addEventListener('keyup', function(e) {
            if (!isVoiceMode) return;
            if (e.code === 'Space' && isRecording) {
                stopRecording();
            }
        });

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        handleRecordingStop();
                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    voiceStartTime = Date.now();
                    
                    // Update UI
                    setRecordingUI();
                    
                    // Start Timer
                    updateTimer();
                    voiceTimerInterval = setInterval(updateTimer, 100);
                })
                .catch(err => {
                    console.error("Error accessing microphone:", err);
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        alert("éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ï¼Œå…è®¸ç½‘ç«™è®¿é—®éº¦å…‹é£ã€‚\nå¦‚æœåœ¨ IDE é¢„è§ˆä¸­æ— æ³•ä½¿ç”¨ï¼Œè¯·å°è¯•åœ¨å¤–éƒ¨æµè§ˆå™¨(Chrome/Edge)ä¸­æ‰“å¼€ã€‚");
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        alert("æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚");
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œå¯èƒ½è¢«å…¶ä»–ç¨‹åºå ç”¨ã€‚");
                    } else {
                        alert("æ— æ³•è®¿é—®éº¦å…‹é£: " + (err.message || err.name));
                    }
                    isRecording = false; // Reset state
                });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(voiceTimerInterval);
                resetVoiceUI();
            }
        }

        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                // Remove onstop handler to prevent sending
                mediaRecorder.onstop = null;
                mediaRecorder.stop();
                // Stop tracks
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            isRecording = false;
            clearInterval(voiceTimerInterval);
            resetVoiceUI();
        }

        function handleRecordingStop() {
            const duration = Date.now() - voiceStartTime;
            if (duration < 1000) {
                alert("å½•åˆ¶æ—¶é—´å°äº1ç§’");
                return;
            }

            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' }); // Try mp3, though browser usually gives webm/ogg
            // Note: MediaRecorder usually produces webm/ogg. Backend accepts mp3/mp4/wav/webm/ogg now.
            // Let's use correct extension based on MIME type or default to webm
            let ext = 'webm';
            if (MediaRecorder.isTypeSupported('audio/webm')) ext = 'webm';
            else if (MediaRecorder.isTypeSupported('audio/ogg')) ext = 'ogg';
            else if (MediaRecorder.isTypeSupported('audio/mp4')) ext = 'm4a';
            
            const file = new File([audioBlob], `voice_${Date.now()}.${ext}`, { type: `audio/${ext}` });
            uploadVoice(file, duration);
        }

        function updateTimer() {
            const diff = Date.now() - voiceStartTime;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            voiceTimer.textContent = `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }



        function uploadVoice(file, durationMs) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('{{ url_for("chat.upload_file") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (ws.readyState === WebSocket.OPEN) {
                        const durationSec = Math.round(durationMs / 1000);
                        const content = `[voice:${data.url}|${durationSec}]`;
                        
                        ws.send(JSON.stringify({
                            type: 'chat',
                            content: content
                        }));
                    }
                } else {
                    alert(data.message || 'å‘é€å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('å‘é€å‡ºé”™');
            });
        }

        /* Edit Profile Logic */
        function openEditProfile() {
            // Close other sidebars
            $('.user-sidebar').removeClass('active');
            $('.settings-sidebar').removeClass('active');
            $('#contactsSidebar').hide(); // Also hide contacts sidebar if open
            $('#editProfileSidebar').fadeIn(200);
        }

        function closeEditProfile() {
            $('#editProfileSidebar').fadeOut(200);
        }

        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#avatarPreview').attr('src', e.target.result).show();
                    $('#avatarPlaceholder').hide();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            var formData = new FormData();
            formData.append('nickname', $('#editNickname').val());
            var fileInput = document.getElementById('avatarUpload');
            if (fileInput.files[0]) {
                formData.append('avatar', fileInput.files[0]);
            }
            
            $.ajax({
                url: "{{ url_for('chat.update_profile') }}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert('ä¿®æ”¹æˆåŠŸ');
                        closeEditProfile();
                    } else {
                        alert('ä¿®æ”¹å¤±è´¥: ' + response.message);
                    }
                },
                error: function() {
                    alert('æœåŠ¡å™¨é”™è¯¯');
                }
            });
        }
        /* Search Friend/Group Logic */
        let currentSearchType = 'user';

        function addFriendOrGroup() {
            $('.add-menu-dropdown').hide();
            $('#searchModal').css('display', 'flex');
            // Reset position
            $('#searchModalContent').css('transform', 'translate(0px, 0px)');
            currentTranslate = { x: 0, y: 0 };
            $('#searchInput').focus();
        }

        /* Draggable Modal Logic */
        let isDragging = false;
        let currentTranslate = { x: 0, y: 0 };
        let dragStart = { x: 0, y: 0 };

        $(document).ready(function() {
            const modalHeader = document.getElementById('searchModalHeader');
            const modalContent = document.getElementById('searchModalContent');
            const searchModal = document.getElementById('searchModal');

            if (modalHeader && modalContent) {
                modalHeader.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    dragStart = {
                        x: e.clientX - currentTranslate.x,
                        y: e.clientY - currentTranslate.y
                    };
                    modalHeader.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    currentTranslate.x = e.clientX - dragStart.x;
                    currentTranslate.y = e.clientY - dragStart.y;

                    modalContent.style.transform = `translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;
                });

                document.addEventListener('mouseup', function() {
                    isDragging = false;
                    if (modalHeader) modalHeader.style.cursor = 'move';
                });
            }

            // Click outside to close
            if (searchModal) {
                searchModal.addEventListener('click', function(e) {
                    // Check if the click target is the modal container itself (not the content)
                    if (e.target === searchModal) {
                        closeSearchModal();
                    }
                });
            }
        });

        function closeSearchModal() {
            $('#searchModal').hide();
            $('#searchInput').val('');
            $('#searchResults').html('<div class="empty-state" style="text-align: center; color: #8b949e; padding-top: 20px;">è¯·è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢</div>');
        }

        function switchSearchTab(type) {
            currentSearchType = type;
            $('.search-tab').css({
                'color': '#8b949e',
                'border-bottom-color': 'transparent'
            });
            
            if (type === 'user') {
                $('.search-tab').eq(0).css({
                    'color': '#58a6ff',
                    'border-bottom-color': '#58a6ff'
                });
                $('#searchInput').attr('placeholder', 'è¯·è¾“å…¥ç”¨æˆ·è´¦å·');
            } else {
                $('.search-tab').eq(1).css({
                    'color': '#58a6ff',
                    'border-bottom-color': '#58a6ff'
                });
                $('#searchInput').attr('placeholder', 'è¯·è¾“å…¥ç¾¤å·æˆ–ç¾¤åç§°');
            }
            
            $('#searchResults').html('<div class="empty-state" style="text-align: center; color: #8b949e; padding-top: 20px;">è¯·è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢</div>');
        }

        function performSearch() {
            const keyword = $('#searchInput').val().trim();
            if (!keyword) return;
            
            const url = currentSearchType === 'user' ? "{{ url_for('chat.search_user') }}" : "{{ url_for('chat.search_group') }}";
            const data = currentSearchType === 'user' ? { username: keyword } : { keyword: keyword };
            
            $('#searchResults').html('<div style="text-align: center; color: #8b949e;">æœç´¢ä¸­...</div>');
            
            $.post(url, data, function(res) {
                if (res.success) {
                    let html = '';
                    if (currentSearchType === 'user') {
                        const u = res.user;
                        html = `
                            <div class="result-item" style="display: flex; align-items: center; padding: 10px; background: #21262d; border-radius: 6px;">
                                ${u.avatar ? 
                                    `<img src="${u.avatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;">` : 
                                    `<div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background: #58a6ff; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${u.username[0].toUpperCase()}</div>`
                                }
                                <div style="flex: 1;">
                                    <div style="color: #e6edf3; font-weight: bold;">${u.nickname || u.username}</div>
                                    <div style="color: #8b949e; font-size: 12px;">@${u.username}</div>
                                </div>
                                <button onclick="sendFriendRequest(${u.id})" style="background: #1f6feb; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">åŠ å¥½å‹</button>
                            </div>
                        `;
                    } else {
                        const g = res.group;
                        html = `
                            <div class="result-item" style="display: flex; align-items: center; padding: 10px; background: #21262d; border-radius: 6px;">
                                <div style="width: 40px; height: 40px; background: #58a6ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                                    <i class="fas fa-users" style="color: white;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #e6edf3; font-weight: bold;">${g.name}</div>
                                    <div style="color: #8b949e; font-size: 12px;">${g.member_count} äºº Â· ID: ${g.id}</div>
                                </div>
                                <button onclick="sendGroupRequest(${g.id})" style="background: #1f6feb; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">åŠ å…¥ç¾¤èŠ</button>
                            </div>
                        `;
                    }
                    $('#searchResults').html(html);
                } else {
                    $('#searchResults').html(`<div style="text-align: center; color: #ff7b72;">${res.message}</div>`);
                }
            }).fail(function(err) {
                 $('#searchResults').html(`<div style="text-align: center; color: #ff7b72;">æœç´¢å¤±è´¥: ${err.responseJSON ? err.responseJSON.message : 'æœªçŸ¥é”™è¯¯'}</div>`);
            });
        }

        function sendFriendRequest(userId) {
            $('#friendRequestUserId').val(userId);
            $('#friendRequestMessage').val('');
            $('#friendRequestRemark').val('');
            $('#friendRequestModal').css('display', 'flex');
        }

        function closeFriendRequestModal() {
            $('#friendRequestModal').hide();
        }

        function confirmSendFriendRequest() {
            const userId = $('#friendRequestUserId').val();
            const message = $('#friendRequestMessage').val();
            const remark = $('#friendRequestRemark').val();
            
            $.post("{{ url_for('chat.send_friend_request') }}", { 
                user_id: userId,
                hello_message: message,
                remark: remark
            }, function(res) {
                if (res.success) {
                    alert(res.message);
                    closeFriendRequestModal();
                    closeSearchModal();
                } else {
                    alert(res.message);
                }
            });
        }

        function sendGroupRequest(groupId) {
            $.post("{{ url_for('chat.join_group_by_id') }}", { group_id: groupId }, function(res) {
                if (res.success) {
                    alert('åŠ å…¥æˆåŠŸï¼');
                    closeSearchModal();
                    location.reload();
                } else {
                    alert(res.message);
                }
            });
        }

        // Friend Notifications Logic
        function showFriendNotifications() {
            $('#chatMainContent').hide();
            $('#friendNotificationsPanel').css('display', 'flex');
            fetchFriendRequests();
        }

        function fetchFriendRequests() {
            $.get("{{ url_for('chat.get_friend_requests') }}", function(res) {
                if (res.success) {
                    renderFriendRequests(res.requests);
                } else {
                    $('#notificationsList').html(`<div style="text-align: center; color: #ff7b72;">${res.message}</div>`);
                }
            }).fail(function() {
                $('#notificationsList').html(`<div style="text-align: center; color: #ff7b72;">åŠ è½½å¤±è´¥</div>`);
            });
        }

        function renderFriendRequests(requests) {
            if (requests.length === 0) {
                $('#notificationsList').html(`
                    <div class="empty-state" style="text-align: center; color: #8b949e; margin-top: 50px;">
                        <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <div>æš‚æ— æ–°çš„å¥½å‹é€šçŸ¥</div>
                    </div>
                `);
                return;
            }

            let html = '';
            requests.forEach(req => {
                html += `
                    <div class="notification-item" style="background: #161b22; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px; display: flex; align-items: flex-start; gap: 15px;">
                        ${req.sender.avatar ? 
                            `<img src="${req.sender.avatar}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">` : 
                            `<div style="width: 50px; height: 50px; border-radius: 50%; background: #58a6ff; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">${req.sender.username[0].toUpperCase()}</div>`
                        }
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: bold; color: #e6edf3; font-size: 16px;">${req.sender.nickname || req.sender.username} <span style="font-size: 12px; color: #8b949e; font-weight: normal;">(@${req.sender.username})</span></div>
                                <div style="font-size: 12px; color: #8b949e;">${req.created_at}</div>
                            </div>
                            <div style="color: #8b949e; margin-bottom: 10px;">è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹</div>
                            <div style="background: #0d1117; padding: 10px; border-radius: 6px; color: #c9d1d9; font-size: 14px; margin-bottom: 10px; border: 1px solid #21262d;">
                                <div><span style="color: #8b949e;">éªŒè¯ä¿¡æ¯:</span> ${req.hello_message}</div>
                                ${req.remark ? `<div><span style="color: #8b949e;">å¤‡æ³¨:</span> ${req.remark}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="handleFriendRequest(${req.id}, 'accept')" style="background: #238636; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">åŒæ„</button>
                                <button onclick="handleFriendRequest(${req.id}, 'reject')" style="background: #da3633; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">æ‹’ç»</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#notificationsList').html(html);
        }

        // Initialize
        $(document).ready(function() {
            fetchFriends();
            fetchChatList();
        });

        function fetchFriends() {
            $.get("{{ url_for('chat.get_friends') }}", function(res) {
                if (res.success) {
                    renderFriends(res.friends);
                }
            });
        }

        function renderFriends(friends) {
            const list = $('#friendListPanel');
            list.empty();
            
            friends.forEach(f => {
                const avatar = f.avatar || '';
                const avatarHtml = avatar 
                    ? `<img src="${avatar}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; object-fit: cover;">`
                    : `<div style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; background: #58a6ff; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">${f.username[0].toUpperCase()}</div>`;
                
                const html = `
                    <div class="contact-item" onclick="openFriendProfile(${f.id})" style="padding: 10px 20px; display: flex; align-items: center; cursor: pointer; color: #c9d1d9;">
                        ${avatarHtml}
                        <div class="contact-info">
                            <div class="contact-name">${f.nickname || f.username}</div>
                            <div class="contact-status" style="font-size: 12px; color: #8b949e;">[ç¦»çº¿]</div>
                        </div>
                    </div>
                `;
                list.append(html);
            });
        }

        function fetchChatList() {
            $.get("{{ url_for('chat.get_chat_list') }}", function(res) {
                if (res.success) {
                    renderChatList(res.chats);
                }
            });
        }

        function renderChatList(chats) {
            const list = $('.chat-list');
            list.empty();
            
            chats.forEach(c => {
                const isActive = c.room === currentRoom ? 'active' : '';
                const avatar = c.avatar || '';
                let avatarHtml;
                
                if (c.type === 'private') {
                     avatarHtml = avatar 
                        ? `<img src="${avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="avatar" style="background: #58a6ff; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${c.name[0].toUpperCase()}</div>`;
                } else {
                    // Group/Server icon
                     avatarHtml = `<div class="avatar"><i class="fas fa-users"></i></div>`;
                }

                const html = `
                    <div class="chat-item ${isActive}" onclick="switchChat('${c.room}', '${c.name}', '${c.type}', '${c.id}')">
                        ${avatarHtml}
                        <div class="chat-info">
                            <div class="chat-name">${c.name}</div>
                            <div class="chat-preview" style="color: #8b949e; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.last_message || 'æš‚æ— æ¶ˆæ¯'}</div>
                        </div>
                    </div>
                `;
                list.append(html);
            });
        }

        function startPrivateChat(room, name, avatar) {
            // Switch to chat tab
            switchTab($('.main-nav-item').eq(0), 'chat');
            // Switch room
            switchChat(room, name, 'private', null);
            
            // Ensure chat view is visible
            $('#friendProfileModal').hide();
            $('#friendNotificationsPanel').hide();
            $('#chatMainContent').css('display', 'flex');

            // Refresh chat list to show this item if not present (handled by backend, but we can force refresh)
            fetchChatList();
        }

        function copyRoomId() {
            const id = $('#currentRoomId').text();
            if (id) {
                copyToClipboard(id);
            }
        }

        function switchChat(room, name, type, id) {
            if (currentRoom === room) return;
            
            // Update UI
            $('.chat-item').removeClass('active');
            // Find item with this room and set active (might need data attribute)
            // For now, re-render will handle it or we can iterate
            
            // Update Top Bar
            $('#chatTitle').text(name);
            
            if (type === 'group' && id && id !== 'server') {
                $('#chatRoomIdContainer').show();
                $('#currentRoomId').text(id);
            } else {
                $('#chatRoomIdContainer').hide();
            }
            
            // Clear messages
            $('#messageArea').empty();
            $('#messageArea').append('<div class="system-message">æ­£åœ¨åˆ‡æ¢æˆ¿é—´...</div>');
            
            // Connect to new room
            connect(room);
            
            // Refresh chat list to update active state
            setTimeout(fetchChatList, 500); // Small delay to allow WS join to potentially update last message if needed
        }

        function handleFriendRequest(requestId, action) {
            $.post("{{ url_for('chat.handle_friend_request') }}", {
                request_id: requestId,
                action: action
            }, function(res) {
                if (res.success) {
                    fetchFriendRequests(); // Refresh notifications
                    if (action === 'accept') {
                        // Refresh Friends List and Chat List
                        fetchFriends();
                        fetchChatList();
                    }
                } else {
                    alert(res.message);
                }
            });
        }
        
        // Restore chat view when clicking chat items
        $(document).on('click', '.chat-item', function() {
            $('#friendNotificationsPanel').hide();
            $('#friendProfileModal').hide();
            $('#chatMainContent').css('display', 'flex');
        });

        // Friend Profile Logic
        /* Friend Profile Logic */
        let currentProfileFriendId = null;

        function openFriendProfile(friendId) {
            currentProfileFriendId = friendId;
            $('#chatMainContent').hide();
            $('#friendNotificationsPanel').hide();
            
            // Show Loading or clear previous data
            $('#friendProfileModal').css('display', 'flex');
            $('#fpAvatarContainer').html('<div style="width:100px;height:100px;background:#161b22;border-radius:50%;"></div>'); // Placeholder
            
            $.post("{{ url_for('chat.get_friend_details') }}", { user_id: friendId }, function(res) {
                if (res.success) {
                    const f = res.friend;
                    
                    // Avatar
                    const avatarHtml = f.avatar 
                        ? `<img src="${f.avatar}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #1f6feb;">`
                        : `<div style="width: 100px; height: 100px; border-radius: 50%; background: #58a6ff; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; font-weight: bold; border: 4px solid #1f6feb;">${f.username[0].toUpperCase()}</div>`;
                    $('#fpAvatarContainer').html(avatarHtml);
                    
                    // Info
                    $('#fpNickname').text(f.nickname || f.username);
                    $('#fpUsername').text('è´¦å·: ' + f.username);
                    $('#fpRemark').text(f.remark || 'æ— å¤‡æ³¨');
                    
                    // Status Check
                    let isOnline = false;
                    if (typeof previousUserList !== 'undefined' && previousUserList.has(f.username)) {
                        isOnline = true;
                    }
                    
                    if (isOnline) {
                        $('#fpStatusDot').css('background', '#238636');
                        $('#fpStatusDot').removeClass('offline');
                        $('#fpStatusText').text('åœ¨çº¿');
                    } else {
                        $('#fpStatusDot').css('background', '#8b949e');
                        $('#fpStatusDot').addClass('offline');
                        $('#fpStatusText').text('ç¦»çº¿');
                    }

                    // Actions
                    $('#fpSendMsgBtn').off('click').on('click', function() {
                        startPrivateChat(f.room, f.nickname || f.username, f.avatar);
                    });
                    
                } else {
                    alert(res.message);
                    $('#friendProfileModal').hide();
                    $('#chatMainContent').show();
                }
            });
        }

        // Create Group Logic
        function createGroupDirect() {
            $('#createGroupModal').css('display', 'flex');
            $('#createGroupName').val('');
            $('#inviteFriendList').html('<div style="color: #8b949e; padding: 5px;">åŠ è½½å¥½å‹åˆ—è¡¨...</div>');
            
            // Fetch friends to invite
            $.post("{{ url_for('chat.get_friends') }}", { username: '{{ username }}' }, function(res) {
                if(res.success) {
                    const list = $('#inviteFriendList');
                    list.empty();
                    if(res.friends.length === 0) {
                        list.html('<div style="color: #8b949e; padding: 5px;">æš‚æ— å¥½å‹å¯é‚€è¯·</div>');
                    } else {
                        res.friends.forEach(f => {
                             const name = f.remark || f.nickname || f.username;
                             const html = `
                                <div style="display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #21262d;">
                                    <input type="checkbox" class="invite-checkbox" value="${f.id}" style="margin-right: 10px;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #58a6ff; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; margin-right: 8px;">${f.username[0].toUpperCase()}</div>
                                    <span style="color: #e6edf3;">${name}</span>
                                </div>
                             `;
                             list.append(html);
                        });
                    }
                } else {
                     $('#inviteFriendList').html('<div style="color: #f85149; padding: 5px;">åŠ è½½å¤±è´¥</div>');
                }
            });
        }
        
        function submitCreateGroup() {
            const name = $('#createGroupName').val().trim();
            if(!name) {
                alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
                return;
            }
            
            const memberIds = [];
            $('.invite-checkbox:checked').each(function() {
                memberIds.push($(this).val());
            });
            
            $.post("{{ url_for('chat.create_group') }}", {
                name: name,
                members: JSON.stringify(memberIds)
            }, function(res) {
                if(res.success) {
                    $('#createGroupModal').hide();
                    
                    // Show Success with Room ID
                    const content = `
                        <div style="padding: 20px; text-align: center; color: #e6edf3;">
                            <div style="color: #238636; font-size: 40px; margin-bottom: 10px;"><i class="fas fa-check-circle"></i></div>
                            <h3 style="margin-bottom: 10px;">åˆ›å»ºæˆåŠŸ</h3>
                            <p style="color: #8b949e; margin-bottom: 20px;">ç¾¤å·: <strong style="color: #58a6ff; font-size: 18px;">${res.room_id}</strong></p>
                            <button class="btn-primary" onclick="copyToClipboard('${res.room_id}')" style="background: #1f6feb; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">å¤åˆ¶ç¾¤å·</button>
                        </div>
                    `;
                    
                    // Use a simple custom modal for success since layer might not be fully configured or we want consistency
                    const successModal = $(`
                        <div id="successModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2200; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
                            <div style="background: #161b22; width: 300px; border-radius: 8px; border: 1px solid #30363d; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5); position: relative;">
                                <i class="fas fa-times" onclick="$('#successModal').remove()" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #8b949e;"></i>
                                ${content}
                            </div>
                        </div>
                    `);
                    $('body').append(successModal);
                    
                } else {
                    alert(res.message);
                }
            });
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }, function(err) {
                console.error('Could not copy text: ', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }
        
        // Join Group Logic
        // Duplicate addFriendOrGroup removed to allow Search Modal access
        
        function submitJoinGroup() {
            const groupId = $('#joinGroupId').val().trim();
            if(!groupId) {
                alert('è¯·è¾“å…¥ç¾¤å·');
                return;
            }
            
            $.post("{{ url_for('chat.join_group_by_id') }}", { group_id: groupId }, function(res) {
                if(res.success) {
                    $('#joinGroupModal').hide();
                    alert('åŠ å…¥æˆåŠŸï¼');
                    location.reload(); // Reload to show new group
                } else {
                    alert(res.message);
                }
            });
        }
    </script>
<!-- Search Modal -->
<div id="searchModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; align-items: center; justify-content: center; pointer-events: auto;">
    <div id="searchModalContent" style="background: #161b22; width: 400px; border-radius: 8px; border: 1px solid #30363d; overflow: hidden; pointer-events: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5); transform: translate(0, 0);">
        <div id="searchModalHeader" style="padding: 15px; border-bottom: 1px solid #21262d; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none;">
            <div style="font-weight: bold; color: #e6edf3;">æ·»åŠ å¥½å‹/ç¾¤èŠ</div>
            <i class="fas fa-times" onclick="closeSearchModal()" style="cursor: pointer; color: #8b949e;"></i>
        </div>
        <div style="padding: 20px;">
            <div class="search-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #21262d;">
                <div class="search-tab active" onclick="switchSearchTab('user')" style="padding: 10px 20px; cursor: pointer; color: #58a6ff; border-bottom: 2px solid #58a6ff;">æ‰¾äºº</div>
                <div class="search-tab" onclick="switchSearchTab('group')" style="padding: 10px 20px; cursor: pointer; color: #8b949e; border-bottom: 2px solid transparent;">æ‰¾ç¾¤</div>
            </div>
            
            <div class="search-input-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·è´¦å·" style="flex: 1; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; padding: 8px 12px; border-radius: 6px; outline: none;">
                <button onclick="performSearch()" style="background: #238636; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">æœç´¢</button>
            </div>
            
            <div id="searchResults" style="min-height: 100px;">
                <div class="empty-state" style="text-align: center; color: #8b949e; padding-top: 20px;">
                    è¯·è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Friend Request Modal -->
<div id="friendRequestModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2100; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
    <div style="background: #161b22; width: 350px; border-radius: 8px; border: 1px solid #30363d; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
        <div style="padding: 15px; border-bottom: 1px solid #21262d; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: bold; color: #e6edf3;">å‘é€å¥½å‹ç”³è¯·</div>
            <i class="fas fa-times" onclick="closeFriendRequestModal()" style="cursor: pointer; color: #8b949e;"></i>
        </div>
        <div style="padding: 20px;">
            <input type="hidden" id="friendRequestUserId">
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">éªŒè¯ä¿¡æ¯</label>
                <textarea id="friendRequestMessage" rows="3" style="width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; padding: 8px; border-radius: 6px; outline: none; resize: none;" placeholder="æˆ‘æ˜¯..."></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">å¤‡æ³¨</label>
                <input type="text" id="friendRequestRemark" style="width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; padding: 8px; border-radius: 6px; outline: none;" placeholder="è®¾ç½®å¤‡æ³¨">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeFriendRequestModal()" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; padding: 6px 12px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button onclick="confirmSendFriendRequest()" style="background: #238636; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">å‘é€</button>
            </div>
        </div>
    </div>
</div>



<!-- Create Group Modal -->
<div id="createGroupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2100; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
    <div style="background: #161b22; width: 400px; border-radius: 8px; border: 1px solid #30363d; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
        <div style="padding: 15px; border-bottom: 1px solid #21262d; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: bold; color: #e6edf3;">åˆ›å»ºç¾¤èŠ</div>
            <i class="fas fa-times" onclick="$('#createGroupModal').hide()" style="cursor: pointer; color: #8b949e;"></i>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">ç¾¤èŠåç§°</label>
                <input type="text" id="createGroupName" style="width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; padding: 8px; border-radius: 6px; outline: none;" placeholder="ç»™ç¾¤èŠèµ·ä¸ªåå­—">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">é‚€è¯·å¥½å‹ (å¯é€‰)</label>
                <div id="inviteFriendList" style="max-height: 200px; overflow-y: auto; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 5px;">
                    <!-- Checkboxes injected by JS -->
                </div>
            </div>
            <button onclick="submitCreateGroup()" style="width: 100%; background: #238636; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">åˆ›å»º</button>
        </div>
    </div>
</div>

<!-- Join Group Modal -->
<div id="joinGroupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2100; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
    <div style="background: #161b22; width: 350px; border-radius: 8px; border: 1px solid #30363d; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
         <div style="padding: 15px; border-bottom: 1px solid #21262d; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: bold; color: #e6edf3;">åŠ å…¥ç¾¤èŠ</div>
            <i class="fas fa-times" onclick="$('#joinGroupModal').hide()" style="cursor: pointer; color: #8b949e;"></i>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">ç¾¤å·</label>
                <input type="text" id="joinGroupId" style="width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; padding: 8px; border-radius: 6px; outline: none;" placeholder="è¯·è¾“å…¥ç¾¤å·">
            </div>
            <button onclick="submitJoinGroup()" style="width: 100%; background: #1f6feb; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">åŠ å…¥</button>
        </div>
    </div>
</div>
</body>
</html>
