<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºè”æ˜Ÿé˜ŸChat - {{ server }}</title>
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/fontawesome/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='css/news.css') }}">
    <script src="{{ url_for('chat.static', filename='vendor/jquery/jquery-3.5.1.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="chat-wrapper">
        <!-- Main Sidebar (Leftmost) -->
        <div class="main-sidebar">
            <div class="main-nav-item active" title="èŠå¤©" onclick="switchTab(this, 'chat')">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div class="main-nav-item" title="å¥½å‹" onclick="switchTab(this, 'friend')">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="main-nav-item" title="æ¸¸æˆ" onclick="switchTab(this, 'game')">
                <i class="fas fa-gamepad"></i>
            </div>
            <div class="main-nav-item" title="è®¾ç½®" style="margin-top: auto;" onclick="switchTab(this, 'settings')">
                <i class="fas fa-cog"></i>
            </div>
            <a href="{{ url_for('chat.logout') }}" class="main-nav-item" title="é€€å‡º" style="text-decoration: none;">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <i class="fas fa-search"></i> æœç´¢
                </div>
            </div>
            
            <div class="chat-list">
                <!-- Static list for now, could be dynamic -->
                <div class="chat-item active">
                    <div class="avatar"><i class="fas fa-users"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">{{ server }}</div>
                        <div class="chat-preview">å½“å‰æ‰€åœ¨æˆ¿é—´</div>
                    </div>
                </div>
                <div class="chat-item">
                    <div class="avatar" style="background: #1f6feb;"><i class="fas fa-bullhorn"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">ç³»ç»Ÿå…¬å‘Š</div>
                        <div class="chat-preview">æ¬¢è¿æ¥åˆ°æ™ºè”æ˜Ÿé˜ŸChat...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat -->
        <div class="main-chat">
            <div class="chat-top-bar">
                <div style="font-weight: bold;">{{ server }}</div>
                <div>
                    <i class="fas fa-ellipsis-h" style="color: #8b949e; cursor: pointer;" onclick="toggleUserSidebar()" title="åœ¨çº¿ç”¨æˆ·"></i>
                </div>
            </div>
            
            <div class="message-area" id="messageArea">
                <!-- Messages will be injected here -->
                <div class="system-message">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
            </div>
            
            <div class="input-area">
                <!-- Emoji Panel -->
                <div class="emoji-panel" id="emojiPanel" style="display: none;">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>

                <div class="toolbar">
                    <i class="far fa-smile" id="emojiBtn" title="è¡¨æƒ…"></i>
                    <i class="far fa-folder"></i>
                    <i class="fas fa-cut"></i>
                    <i class="far fa-comment-dots"></i>
                </div>
                <textarea class="input-box" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                <div style="text-align: right; margin-top: 5px;">
                    <button class="btn-login" id="sendBtn" style="width: auto; padding: 5px 20px; font-size: 14px;">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Video Overlay -->
    <div id="weatherOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: none; pointer-events: none;">
        <video id="weatherVideo" style="width: 100%; height: 100%; object-fit: cover;" muted></video>
    </div>

    <!-- User Sidebar -->
    <div class="user-sidebar" id="userSidebar">
        <div class="user-sidebar-header">
            <span>åœ¨çº¿ç”¨æˆ·(<span id="userCount">0</span>)</span>
            <i class="fas fa-times close-sidebar" onclick="toggleUserSidebar()"></i>
        </div>
        <div class="user-list" id="userList">
            <!-- User items injected here -->
        </div>
    </div>

    <!-- Settings Sidebar -->
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-sidebar-header">
            <span>è®¾ç½®</span>
            <i class="fas fa-times close-sidebar" onclick="closeSettingsSidebar()"></i>
        </div>
        <div class="settings-list">
            <div class="setting-item">
                <span class="setting-label">æ–°æ¶ˆæ¯æç¤ºéŸ³</span>
                <label class="switch">
                    <input type="checkbox" id="toggleMsgSound" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">å¥½å‹ä¸Šçº¿æç¤ºéŸ³</span>
                <label class="switch">
                    <input type="checkbox" id="toggleUserSound" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">å‘é€æ¶ˆæ¯æç¤ºéŸ³</span>
                <label class="switch">
                    <input type="checkbox" id="toggleSelfSound" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="audioMsgComing" src="{{ url_for('chat.static', filename='mp3/msgcoming.mp3') }}" preload="auto"></audio>
    <audio id="audioUserComing" src="{{ url_for('chat.static', filename='mp3/usercoming.mp3') }}" preload="auto"></audio>
    <audio id="audioUserSendMsg" src="{{ url_for('chat.static', filename='mp3/usersendmsg.mp3') }}" preload="auto"></audio>

    <script>
        const user = "{{ user }}";
        const room = "{{ server }}";
        // Construct WS URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/chat/ws`;
        
        let ws;
        let previousUserList = new Set();
        let isFirstLoad = true;

        // Load settings from localStorage
        const settings = {
            msgSound: localStorage.getItem('msgSound') !== 'false',
            userSound: localStorage.getItem('userSound') !== 'false',
            selfSound: localStorage.getItem('selfSound') !== 'false'
        };

        // Initialize checkboxes
        $('#toggleMsgSound').prop('checked', settings.msgSound);
        $('#toggleUserSound').prop('checked', settings.userSound);
        $('#toggleSelfSound').prop('checked', settings.selfSound);

        // Settings event listeners
        $('#toggleMsgSound').change(function() {
            settings.msgSound = this.checked;
            localStorage.setItem('msgSound', this.checked);
        });
        $('#toggleUserSound').change(function() {
            settings.userSound = this.checked;
            localStorage.setItem('userSound', this.checked);
        });
        $('#toggleSelfSound').change(function() {
            settings.selfSound = this.checked;
            localStorage.setItem('selfSound', this.checked);
        });

        function playSound(type) {
            let audioId = '';
            let shouldPlay = false;

            if (type === 'msg' && settings.msgSound) {
                audioId = 'audioMsgComing';
                shouldPlay = true;
            } else if (type === 'user' && settings.userSound) {
                audioId = 'audioUserComing';
                shouldPlay = true;
            } else if (type === 'self' && settings.selfSound) {
                audioId = 'audioUserSendMsg';
                shouldPlay = true;
            }

            if (shouldPlay && audioId) {
                const audio = document.getElementById(audioId);
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed:", e));
                }
            }
        }

        function connect() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log("Connected");
                $('.system-message').last().text('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                // Send join message
                ws.send(JSON.stringify({
                    type: 'join',
                    user: user,
                    room: room
                }));
            };
            
            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                if (msg.type === 'users') {
                    updateUserList(msg.users, msg.count);
                } else if (msg.type === 'stream_start') {
                    startStreamMessage(msg);
                } else if (msg.type === 'stream_chunk') {
                    appendStreamChunk(msg);
                } else if (msg.type === 'stream_end') {
                    endStreamMessage(msg);
                } else if (msg.type === 'weather') {
                    displayWeather(msg);
                } else {
                    appendMessage(msg);
                }
            };
            
            ws.onclose = function() {
                console.log("Disconnected");
                appendMessage({type: 'system', content: 'è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', timestamp: ''});
                setTimeout(connect, 3000); // Reconnect
            };
            
            ws.onerror = function(err) {
                console.error("WS Error", err);
            };
        }
        
        connect();
        
        let currentStreamId = null;
        let currentStreamContent = "";

        function startStreamMessage(msg) {
            currentStreamId = 'stream-' + Date.now();
            currentStreamContent = "";
            const area = $('#messageArea');
            const avatar = msg.user ? msg.user[0].toUpperCase() : '?';
            
            playSound('msg');

            const html = `
                <div class="message other" id="${currentStreamId}">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #238636">${avatar}</div>
                    <div>
                        <div class="message-meta" style="text-align: left">${msg.user}</div>
                        <div class="message-content markdown-body">
                            <span class="typing-indicator">...</span>
                        </div>
                    </div>
                </div>
            `;
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
        }

        function appendStreamChunk(msg) {
            if (currentStreamId) {
                currentStreamContent += msg.content;
                const contentDiv = $(`#${currentStreamId} .message-content`);
                try {
                    contentDiv.html(marked.parse(currentStreamContent));
                } catch(e) {
                    contentDiv.text(currentStreamContent);
                }
                const area = $('#messageArea');
                area.scrollTop(area[0].scrollHeight);
            }
        }

        function endStreamMessage(msg) {
            currentStreamId = null;
            currentStreamContent = "";
        }

        function getWeatherClass(type) {
            if (type.includes('é›¨')) return 'rain';
            if (type.includes('é›ª')) return 'snow';
            if (type.includes('é›·')) return 'thunder';
            if (type.includes('é£')) return 'wind';
            if (type.includes('é›¾') || type.includes('éœ¾')) return 'fog';
            if (type.includes('æ™´')) return 'sunny';
            if (type.includes('é˜´')) return 'overcast';
            if (type.includes('äº‘')) return 'cloudy';
            return 'default';
        }

        function playWeatherVideo(data) {
            let weatherType = 'æ™´';
            
            // Heuristic parsing
            if (data.data) {
                if (data.data.type) weatherType = data.data.type;
            } else if (data.weather) {
                weatherType = data.weather;
            }
            
            // Map to video file - Priority: Thunder > Snow > Rain > Wind > Fog > Cloud > Sun
            let videoFile = 'sun.mp4';
            if (weatherType.includes('é›·')) videoFile = 'thunder.mp4';
            else if (weatherType.includes('é›ª')) videoFile = 'snow.mp4';
            else if (weatherType.includes('é›¨')) videoFile = 'rain.mp4';
            else if (weatherType.includes('é£') && !weatherType.includes('å¾®é£')) videoFile = 'wind.mp4';
            else if (weatherType.includes('é›¾') || weatherType.includes('éœ¾')) videoFile = 'fog.mp4';
            else if (weatherType.includes('å¤šäº‘')) videoFile = 'cloudy.mp4';
            else if (weatherType.includes('é˜´') || weatherType.includes('äº‘')) videoFile = 'cloud.mp4';
            else if (weatherType.includes('æ™´')) videoFile = 'sun.mp4';

            // Correctly construct video path
            const videoBaseUrl = "{{ url_for('chat.static', filename='weather') }}";
            const videoPath = videoBaseUrl + '/' + videoFile;
            
            console.log(`[Weather] Playing video: ${videoPath} for type: ${weatherType}`);

            const overlay = $('#weatherOverlay');
            const video = $('#weatherVideo');
            
            video.attr('src', videoPath);
            
            // Force z-index logic before playing
            overlay.css('display', 'block').css('opacity', 0).animate({opacity: 1}, 500); 
            
            // Make chat transparent
            $('.chat-wrapper').css('z-index', '1').css('position', 'relative');
            $('.main-chat').css('background', 'rgba(13, 17, 23, 0.3)'); 
            
            // Play with error handling
            video[0].play().catch(e => {
                console.error("[Weather] Video play failed:", e);
                video[0].muted = true;
                video[0].play().catch(e2 => console.error("Retry failed:", e2));
            });
            
            // Hide after video ends or 10 seconds
            const hideVideo = () => {
                overlay.fadeOut(500, () => {
                    // Restore background
                    $('.main-chat').css('background', '');
                });
            };

            video.off('ended').on('ended', hideVideo);
            setTimeout(hideVideo, 10000);
        }

        function displayWeather(msg) {
            // 1. Play Video
            playWeatherVideo(msg.data);

            // 2. Display Card
            const data = msg.data;
            let weatherType = 'æ™´';
            let city = 'æœªçŸ¥';
            let temp = '';
            let wind = '';
            let date = '';
            
            // Heuristic parsing
            if (data.data) {
                if (data.data.type) weatherType = data.data.type;
                if (data.data.city) city = data.data.city;
                if (data.data.wendu) temp = data.data.wendu;
                if (data.data.fengxiang) wind = data.data.fengxiang;
                if (data.data.date) date = data.data.date;
            } else if (data.weather) {
                weatherType = data.weather;
            }
            
            if (!date) {
                const now = new Date();
                date = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
            }

            const area = $('#messageArea');
            const html = `
                <div class="message other">
                     <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #e6a23c">å¤©</div>
                     <div>
                        <div class="message-meta">å°å¤©æ°”</div>
                        <div class="message-content weather-card ${getWeatherClass(weatherType)}">
                            <div class="weather-header">
                                <div>
                                    <span class="weather-city">${city}</span>
                                    <div class="weather-date">${date}</div>
                                </div>
                                <span class="weather-time">${msg.timestamp}</span>
                            </div>
                            <div class="weather-main">
                                <div class="weather-icon">
                                    <i class="fas ${getWeatherIcon(weatherType)}"></i>
                                </div>
                                <div class="weather-temp">${temp}Â°C</div>
                            </div>
                            <div class="weather-details">
                                <div>${weatherType}</div>
                                <div>${wind}</div>
                            </div>
                        </div>
                     </div>
                </div>
            `;
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
            playSound('msg');
        }

        function getWeatherIcon(type) {
            if (type.includes('é›¨')) return 'fa-cloud-rain';
            if (type.includes('é›ª')) return 'fa-snowflake';
            if (type.includes('é›·')) return 'fa-bolt';
            if (type.includes('é£')) return 'fa-wind';
            if (type.includes('é›¾') || type.includes('éœ¾')) return 'fa-smog';
            if (type.includes('æ™´')) return 'fa-sun';
            if (type.includes('å¤šäº‘')) return 'fa-cloud-sun';
            if (type.includes('é˜´') || type.includes('äº‘')) return 'fa-cloud';
            return 'fa-sun';
        }

        function renderWeatherCard(msg, data) {
            let weatherType = 'æ™´';
            let city = 'æœªçŸ¥';
            let temp = '';
            let wind = '';
            let date = '';
            
            if (data.data) {
                if (data.data.type) weatherType = data.data.type;
                if (data.data.city) city = data.data.city;
                if (data.data.wendu) temp = data.data.wendu;
                if (data.data.fengxiang) wind = data.data.fengxiang;
                if (data.data.date) date = data.data.date;
            } else if (data.weather) {
                weatherType = data.weather;
            }
            
            if (!date) {
                const now = new Date();
                date = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
            }
            
            return `
                <div class="message other">
                     <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #e6a23c">å¤©</div>
                     <div>
                        <div class="message-meta">å°å¤©æ°”</div>
                        <div class="message-content weather-card ${getWeatherClass(weatherType)}">
                            <div class="weather-header">
                                <div>
                                    <span class="weather-city">${city}</span>
                                    <div class="weather-date">${date}</div>
                                </div>
                                <span class="weather-time">${msg.timestamp}</span>
                            </div>
                            <div class="weather-main">
                                <div class="weather-icon">
                                    <i class="fas ${getWeatherIcon(weatherType)}"></i>
                                </div>
                                <div class="weather-temp">${temp}Â°C</div>
                            </div>
                            <div class="weather-details">
                                <div>${weatherType}</div>
                                <div>${wind}</div>
                            </div>
                        </div>
                     </div>
                </div>
            `;
        }

        function renderMusicGift(msg, data, specialPayload) {
            const musicData = specialPayload.data.data || specialPayload.data; // Handle potential nesting
            const cover = musicData.cover || 'https://via.placeholder.com/150';
            const title = musicData.name || 'æœªçŸ¥æ­Œæ›²';
            const artist = musicData.artistsname || 'æœªçŸ¥æ­Œæ‰‹';
            const url = musicData.url || '';
            const uniqueId = 'music-' + Date.now() + Math.random().toString(36).substr(2, 9);

            return `
                <div class="message other">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #d9534f"><i class="fas fa-music"></i></div>
                    <div>
                        <div class="message-meta">å°éŸ³ä¹</div>
                        <div class="music-gift" onclick="openMusicPlayer('${uniqueId}', '${cover}', '${title}', '${artist}', '${url}', this)">
                            <div class="music-gift-icon"></div>
                            <div class="music-gift-content">
                                <div class="music-gift-title">é€ä½ ä¸€é¦–ã€Š${title}ã€‹</div>
                                <div class="music-gift-desc">ç‚¹å‡»é¢†å–éŸ³ä¹åŒ…</div>
                            </div>
                        </div>
                        <div id="${uniqueId}" style="display:none;"></div>
                    </div>
                </div>
            `;
        }

        function renderMusicPlayerHtml(cover, title, artist, url) {
             return `
                <div class="music-card">
                    <div class="music-card-cover" style="background-image: url('${cover}')"></div>
                    <div class="music-card-info">
                        <div class="music-card-title">${title}</div>
                        <div class="music-card-artist">${artist}</div>
                    </div>
                    <div class="music-card-controls">
                        <div class="music-control-btn" onclick="nextSong(this)" title="åˆ‡æ­Œ">
                            <i class="fas fa-step-forward"></i>
                        </div>
                        <div class="music-play-btn" onclick="togglePlay(this, '${url}')">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <audio src="${url}" onended="resetPlayBtn(this)"></audio>
                </div>
            `;
        }

        window.nextSong = function(btn) {
            const container = btn.closest('.music-card');
            const icon = btn.querySelector('i');
            
            // Animation
            icon.className = 'fas fa-spinner fa-spin';
            
            fetch('/api/music/random')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200 && data.data) {
                        const song = data.data;
                        const cover = song.cover || 'https://via.placeholder.com/150';
                        const title = song.name || 'æœªçŸ¥æ­Œæ›²';
                        const artist = song.artistsname || 'æœªçŸ¥æ­Œæ‰‹';
                        const url = song.url || '';
                        
                        // Update UI
                        container.querySelector('.music-card-cover').style.backgroundImage = `url('${cover}')`;
                        container.querySelector('.music-card-title').innerText = title;
                        container.querySelector('.music-card-artist').innerText = artist;
                        
                        const audio = container.querySelector('audio');
                        audio.src = url;
                        
                        // Update Play Button State
                        const playBtnIcon = container.querySelector('.music-play-btn i');
                        playBtnIcon.className = 'fas fa-pause';
                        
                        // Pause others
                        document.querySelectorAll('audio').forEach(a => {
                            if (a !== audio) {
                                a.pause();
                                const otherBtn = a.closest('.music-card')?.querySelector('.music-play-btn i');
                                if (otherBtn) otherBtn.className = 'fas fa-play';
                            }
                        });

                        // Play
                        audio.play().catch(e => console.error("Play failed", e));
                    } else {
                        console.error("Failed to load song", data);
                        // Optional: Show error toast
                    }
                })
                .catch(err => console.error("API Error", err))
                .finally(() => {
                    icon.className = 'fas fa-step-forward';
                });
        };

        window.openMusicPlayer = function(id, cover, title, artist, url, element) {
            // Replace Gift with Player
            const container = document.getElementById(id);
            if (container) {
                container.innerHTML = renderMusicPlayerHtml(cover, title, artist, url);
                container.style.display = 'block';
                element.style.display = 'none'; // Hide gift
            }
        };

        window.togglePlay = function(btn, url) {
            const container = btn.closest('.music-card');
            const audio = container.querySelector('audio');
            const icon = btn.querySelector('i');
            
            // Pause all other audios
            document.querySelectorAll('audio').forEach(a => {
                if (a !== audio) {
                    a.pause();
                    // Reset other buttons
                    const otherBtn = a.closest('.music-card')?.querySelector('.music-play-btn i');
                    if (otherBtn) {
                        otherBtn.className = 'fas fa-play';
                    }
                }
            });

            if (audio.paused) {
                audio.play();
                icon.className = 'fas fa-pause';
            } else {
                audio.pause();
                icon.className = 'fas fa-play';
            }
        };

        window.resetPlayBtn = function(audio) {
            const btn = audio.closest('.music-card').querySelector('.music-play-btn i');
            if (btn) btn.className = 'fas fa-play';
        };

        function renderMusicPrivate(msg, data, specialPayload) {
            // Only render if target matches current user
            if (specialPayload.target_user !== user) {
                // Return empty string or hidden div
                 return '';
            }

            const musicData = specialPayload.data.data || specialPayload.data;
            const cover = musicData.cover || 'https://via.placeholder.com/150';
            const title = musicData.name || 'æœªçŸ¥æ­Œæ›²';
            const artist = musicData.artistsname || 'æœªçŸ¥æ­Œæ‰‹';
            const url = musicData.url || '';

            return `
                <div class="message other">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #6f42c1"><i class="fas fa-headphones"></i></div>
                    <div>
                        <div class="message-meta">å°éŸ³ä¹ (ç§äº«)</div>
                        ${renderMusicPlayerHtml(cover, title, artist, url)}
                    </div>
                </div>
            `;
        }

        function renderNewsCard(msg, data) {
            // data is the full response object from backend get_news_data()
            // structure: {code: 200, msg: "...", data: { newsList: [], swiperList: [] }}
            
            const apiData = data.data || {};
            const newsList = apiData.newsList || [];
            const swiperList = apiData.swiperList || [];
            const uniqueId = 'news-' + Date.now() + Math.random().toString(36).substr(2, 9);
            
            // Generate Header HTML (Swiper)
            let headerHtml = '';
            if (swiperList.length > 0) {
                let imgsHtml = swiperList.map((item, index) => 
                    `<img src="${item.url}" class="news-header-img ${index === 0 ? 'active' : ''}" data-index="${index}">`
                ).join('');
                
                headerHtml = `
                    <div class="news-header" id="header-${uniqueId}">
                        ${imgsHtml}
                        <div class="news-header-title">ä»Šæ—¥çƒ­ç‚¹</div>
                    </div>
                `;
                
                // Auto-init slideshow
                setTimeout(() => startNewsSlideshow(`header-${uniqueId}`), 500);
            }

            // Generate List HTML
            let listHtml = newsList.map((item, index) => {
                const scoreClass = item.score >= 80 ? 'score-high' : (item.score >= 60 ? 'score-mid' : 'score-low');
                const topClass = index < 3 ? 'top-3' : '';
                return `
                    <a href="${item.url}" target="_blank" class="news-item">
                        <div class="news-item-index ${topClass}">${index + 1}</div>
                        <div class="news-item-content">
                            <div class="news-item-title">${item.title}</div>
                            <div class="news-item-meta">
                                <span class="news-tag">${item.category || 'æ–°é—»'}</span>
                                <span class="news-score ${scoreClass}">ğŸ”¥ ${item.score}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            return `
                <div class="message other">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #d29922"><i class="fas fa-newspaper"></i></div>
                    <div>
                        <div class="message-meta">å°æ–°é—»</div>
                        <div class="news-card">
                            ${headerHtml}
                            <div class="news-list">
                                ${listHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function startNewsSlideshow(headerId) {
            const header = document.getElementById(headerId);
            if (!header) return;
            const imgs = header.querySelectorAll('.news-header-img');
            if (imgs.length <= 1) return;
            
            let currentIndex = 0;
            setInterval(() => {
                imgs[currentIndex].classList.remove('active');
                currentIndex = (currentIndex + 1) % imgs.length;
                imgs[currentIndex].classList.add('active');
            }, 3000);
        }

        function renderVideoEmbed(msg, data) {
            const isDirectFile = /\.(mp4|webm|ogg|mov|m4v)($|\?)/i.test(data.src);
            
            const playerHtml = isDirectFile 
                ? `<video class="video-iframe" style="display:none; object-fit: contain; background: #000; width: 100%; height: 100%;" controls playsinline></video>`
                : `<iframe class="video-iframe" style="display:none; width: 100%; height: 100%; border: none;" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;

            const fullscreenBtn = !isDirectFile ? `
                <a href="javascript:void(0)" onclick="toggleFullscreen(this)" style="color: #58a6ff; text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s; margin-right: 10px;">
                    <i class="fas fa-expand"></i> å…¨å±
                </a>` : '';

            return `
                <div class="message other">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #6f42c1"><i class="fas fa-video"></i></div>
                    <div>
                        <div class="message-meta">å°è§†é¢‘</div>
                        <div class="video-embed-card">
                            <div class="video-ratio-box">
                                <div class="video-placeholder" onclick="loadVideo(this, '${data.src}', ${isDirectFile})">
                                    <i class="fas fa-play-circle"></i>
                                    <span>ç‚¹å‡»æ’­æ”¾è§†é¢‘</span>
                                </div>
                                ${playerHtml}
                            </div>
                            <div class="video-card-footer" style="padding: 8px 12px; background: #161b22; border-top: 1px solid rgba(255,255,255,0.1); text-align: right;">
                                ${fullscreenBtn}
                                <a href="${data.src}" target="_blank" style="color: #58a6ff; text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s;">
                                    <i class="fas fa-external-link-alt"></i> æ–°çª—å£è§‚çœ‹
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.loadVideo = function(element, src, isDirectFile) {
            const wrapper = element.parentElement;
            const videoEl = wrapper.querySelector('.video-iframe');
            element.style.display = 'none';
            videoEl.style.display = 'block';
            videoEl.src = src;
            
            if (isDirectFile && videoEl.tagName === 'VIDEO') {
                videoEl.play().catch(e => console.error("Auto-play failed:", e));
            }
        };

        window.toggleFullscreen = function(btn) {
            const wrapper = btn.closest('.video-embed-card');
            const iframe = wrapper.querySelector('iframe.video-iframe');
            if (iframe) {
                if (iframe.requestFullscreen) {
                    iframe.requestFullscreen();
                } else if (iframe.webkitRequestFullscreen) {
                    iframe.webkitRequestFullscreen();
                } else if (iframe.msRequestFullscreen) {
                    iframe.msRequestFullscreen();
                }
            }
        };

        function appendMessage(msg) {
            const area = $('#messageArea');
            let html = '';
            
            if (msg.type === 'system') {
                html = `<div class="system-message">${msg.content} <span style="font-size:10px;">${msg.timestamp}</span></div>`;
            } else if (msg.type === 'chat') {
                // Check for SPECIAL content
                if (msg.content && msg.content.startsWith('SPECIAL:')) {
                    console.log("Received SPECIAL message:", msg.content);
                    try {
                        const specialJson = msg.content.substring(8);
                        const specialPayload = JSON.parse(specialJson);
                        const type = specialPayload.type;
                        
                        console.log("SPECIAL type:", type);

                        if (type === 'weather') {
                            playWeatherVideo(specialPayload.data);
                            html = renderWeatherCard(msg, specialPayload.data);
                        } else if (type === 'music_gift') {
                            html = renderMusicGift(msg, specialPayload.data, specialPayload);
                        } else if (type === 'music_private') {
                            html = renderMusicPrivate(msg, specialPayload.data, specialPayload);
                        } else if (type === 'news_card') {
                            html = renderNewsCard(msg, specialPayload.data);
                        } else if (type === 'video_embed') {
                            html = renderVideoEmbed(msg, specialPayload.data);
                        } else {
                            // Fallback to text
                            html = `<div class="system-message">Unknown Special Message: ${type}</div>`;
                        }
                    } catch(e) {
                        console.error("Special msg parse error", e);
                        html = `<div class="system-message">Error parsing special message: ${e.message}</div>`;
                    }
                } else {
                    // Normal Chat Message
                    const isSelf = msg.user === user;
                    
                    // Play sound only if not history
                    if (!msg.is_history) {
                        if (isSelf) {
                            playSound('self');
                        } else {
                            playSound('msg');
                        }
                    }

                    const cls = isSelf ? 'self' : 'other';
                    const avatar = isSelf ? user[0].toUpperCase() : (msg.user ? msg.user[0].toUpperCase() : '?');
                    
                    let renderedContent = msg.content;
                    try {
                        renderedContent = marked.parse(msg.content);
                    } catch(e) {
                        console.error("Markdown parse error", e);
                    }

                    html = `
                        <div class="message ${cls}">
                            <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: ${isSelf ? '#1f6feb' : '#238636'}">${avatar}</div>
                            <div>
                                <div class="message-meta" style="text-align: ${isSelf ? 'right' : 'left'}">${isSelf ? '' : msg.user}</div>
                                <div class="message-content markdown-body">
                                    ${renderedContent}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (html) {
                area.append(html);
                area.scrollTop(area[0].scrollHeight);
            }
        }
        
        $('#sendBtn').click(sendMessage);
        $('#messageInput').keypress(function(e) {
            if (e.which == 13 && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        function sendMessage() {
            const input = $('#messageInput');
            const content = input.val().trim();
            if (content && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    content: content
                }));
                input.val('');
            }
        }
        
        function toggleUserSidebar() {
            $('.user-sidebar').toggleClass('active');
            if ($('.user-sidebar').hasClass('active')) {
                $('.settings-sidebar').removeClass('active');
            }
        }

        function switchTab(element, tabName) {
            // Remove active from all nav items
            $('.main-nav-item').removeClass('active');
            // Add active to clicked item
            $(element).addClass('active');

            if (tabName === 'settings') {
                $('.settings-sidebar').addClass('active');
                $('.user-sidebar').removeClass('active');
            } else {
                $('.settings-sidebar').removeClass('active');
            }
        }

        function closeSettingsSidebar() {
            $('.settings-sidebar').removeClass('active');
            // Revert active state to Chat
            $('.main-nav-item').removeClass('active');
            $('.main-nav-item[title="èŠå¤©"]').addClass('active');
        }

        function updateUserList(users, count) {
            $('#userCount').text(count);
            const list = $('#userList');
            list.empty();
            
            // Check for new users
            const currentUserSet = new Set(users);
            
            if (!isFirstLoad) {
                for (let u of currentUserSet) {
                    if (!previousUserList.has(u) && u !== user) {
                        playSound('user');
                        break; // Play once per update batch
                    }
                }
            }
            
            previousUserList = currentUserSet;
            isFirstLoad = false;

            users.forEach(u => {
                const isSelf = u === user;
                const html = `
                    <div class="user-item">
                        <div class="avatar" style="width: 30px; height: 30px; font-size: 12px; background: ${isSelf ? '#1f6feb' : '#238636'}">
                            ${u[0].toUpperCase()}
                        </div>
                        <div class="user-name" style="${isSelf ? 'color: #58a6ff;' : ''}">
                            ${u} ${isSelf ? '(æˆ‘)' : ''}
                        </div>
                    </div>
                `;
                list.append(html);
            });
        }

        // Emoji Logic
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const messageInput = document.getElementById('messageInput');
        
        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜',
            'ğŸ˜', 'ğŸ˜˜', 'ğŸ¥°', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤©', 'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜',
            'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´',
            'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²',
            'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©',
            'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬',
            'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¥³', 'ğŸ¥´', 'ğŸ¥º',
            'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ’€', 'ğŸ‘»', 'ğŸ‘½',
            'ğŸ¤–', 'ğŸ’©', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ‘‹',
            'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ',
            'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘',
            'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦µ', 'ğŸ¦¿',
            'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹'
        ];

        // Populate Emojis
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = emoji;
            span.onclick = function() {
                messageInput.value += emoji;
                messageInput.focus();
            };
            emojiGrid.appendChild(span);
        });

        // Toggle Panel
        emojiBtn.onclick = function(e) {
            e.stopPropagation();
            if (emojiPanel.style.display === 'none') {
                emojiPanel.style.display = 'block';
            } else {
                emojiPanel.style.display = 'none';
            }
        };

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (emojiPanel.style.display !== 'none' && !emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.style.display = 'none';
            }
        });
    </script>
</body>
</html>