<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºè”æ˜Ÿé˜ŸChat - {{ server }}</title>
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='vendor/fontawesome/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('chat.static', filename='css/style.css') }}">
    <script src="{{ url_for('chat.static', filename='vendor/jquery/jquery-3.5.1.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="chat-wrapper">
        <!-- Main Sidebar (Leftmost) -->
        <div class="main-sidebar">
            <div class="main-nav-item active" title="èŠå¤©" onclick="switchTab(this, 'chat')">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div class="main-nav-item" title="å¥½å‹" onclick="switchTab(this, 'friend')">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="main-nav-item" title="æ¸¸æˆ" onclick="switchTab(this, 'game')">
                <i class="fas fa-gamepad"></i>
            </div>
            <div class="main-nav-item" title="è®¾ç½®" style="margin-top: auto;" onclick="switchTab(this, 'settings')">
                <i class="fas fa-cog"></i>
            </div>
            <a href="{{ url_for('chat.logout') }}" class="main-nav-item" title="é€€å‡º" style="text-decoration: none;">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <i class="fas fa-search"></i> æœç´¢
                </div>
            </div>
            
            <div class="chat-list">
                <!-- Static list for now, could be dynamic -->
                <div class="chat-item active">
                    <div class="avatar"><i class="fas fa-users"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">{{ server }}</div>
                        <div class="chat-preview">å½“å‰æ‰€åœ¨æˆ¿é—´</div>
                    </div>
                </div>
                <div class="chat-item">
                    <div class="avatar" style="background: #1f6feb;"><i class="fas fa-bullhorn"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">ç³»ç»Ÿå…¬å‘Š</div>
                        <div class="chat-preview">æ¬¢è¿æ¥åˆ°æ™ºè”æ˜Ÿé˜ŸChat...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat -->
        <div class="main-chat">
            <div class="chat-top-bar">
                <div style="font-weight: bold;">{{ server }}</div>
                <div>
                    <i class="fas fa-ellipsis-h" style="color: #8b949e; cursor: pointer;" onclick="toggleUserSidebar()" title="åœ¨çº¿ç”¨æˆ·"></i>
                </div>
            </div>
            
            <div class="message-area" id="messageArea">
                <!-- Messages will be injected here -->
                <div class="system-message">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
            </div>
            
            <div class="input-area">
                <!-- Emoji Panel -->
                <div class="emoji-panel" id="emojiPanel" style="display: none;">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>

                <div class="toolbar">
                    <i class="far fa-smile" id="emojiBtn" title="è¡¨æƒ…"></i>
                    <i class="far fa-folder"></i>
                    <i class="fas fa-cut"></i>
                    <i class="far fa-comment-dots"></i>
                </div>
                <textarea class="input-box" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                <div style="text-align: right; margin-top: 5px;">
                    <button class="btn-login" id="sendBtn" style="width: auto; padding: 5px 20px; font-size: 14px;">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Video Overlay -->
    <div id="weatherOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; pointer-events: none;">
        <video id="weatherVideo" style="width: 100%; height: 100%; object-fit: cover;" muted></video>
    </div>

    <!-- User Sidebar -->
    <div class="user-sidebar" id="userSidebar">
        <div class="user-sidebar-header">
            <span>åœ¨çº¿ç”¨æˆ·(<span id="userCount">0</span>)</span>
            <i class="fas fa-times close-sidebar" onclick="toggleUserSidebar()"></i>
        </div>
        <div class="user-list" id="userList">
            <!-- User items injected here -->
        </div>
    </div>

    <!-- Settings Sidebar -->
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-sidebar-header">
            <span>è®¾ç½®</span>
            <i class="fas fa-times close-sidebar" onclick="closeSettingsSidebar()"></i>
        </div>
        <div class="settings-list">
            <div class="setting-item">
                <span class="setting-label">æ–°æ¶ˆæ¯æç¤ºéŸ³</span>
                <label class="switch">
                    <input type="checkbox" id="toggleMsgSound" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">å¥½å‹ä¸Šçº¿æç¤ºéŸ³</span>
                <label class="switch">
                    <input type="checkbox" id="toggleUserSound" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">å‘é€æ¶ˆæ¯æç¤ºéŸ³</span>
                <label class="switch">
                    <input type="checkbox" id="toggleSelfSound" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="audioMsgComing" src="{{ url_for('chat.static', filename='mp3/msgcoming.mp3') }}" preload="auto"></audio>
    <audio id="audioUserComing" src="{{ url_for('chat.static', filename='mp3/usercoming.mp3') }}" preload="auto"></audio>
    <audio id="audioUserSendMsg" src="{{ url_for('chat.static', filename='mp3/usersendmsg.mp3') }}" preload="auto"></audio>

    <script>
        const user = "{{ user }}";
        const room = "{{ server }}";
        // Construct WS URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/chat/ws`;
        
        let ws;
        let previousUserList = new Set();
        let isFirstLoad = true;

        // Load settings from localStorage
        const settings = {
            msgSound: localStorage.getItem('msgSound') !== 'false',
            userSound: localStorage.getItem('userSound') !== 'false',
            selfSound: localStorage.getItem('selfSound') !== 'false'
        };

        // Initialize checkboxes
        $('#toggleMsgSound').prop('checked', settings.msgSound);
        $('#toggleUserSound').prop('checked', settings.userSound);
        $('#toggleSelfSound').prop('checked', settings.selfSound);

        // Settings event listeners
        $('#toggleMsgSound').change(function() {
            settings.msgSound = this.checked;
            localStorage.setItem('msgSound', this.checked);
        });
        $('#toggleUserSound').change(function() {
            settings.userSound = this.checked;
            localStorage.setItem('userSound', this.checked);
        });
        $('#toggleSelfSound').change(function() {
            settings.selfSound = this.checked;
            localStorage.setItem('selfSound', this.checked);
        });

        function playSound(type) {
            let audioId = '';
            let shouldPlay = false;

            if (type === 'msg' && settings.msgSound) {
                audioId = 'audioMsgComing';
                shouldPlay = true;
            } else if (type === 'user' && settings.userSound) {
                audioId = 'audioUserComing';
                shouldPlay = true;
            } else if (type === 'self' && settings.selfSound) {
                audioId = 'audioUserSendMsg';
                shouldPlay = true;
            }

            if (shouldPlay && audioId) {
                const audio = document.getElementById(audioId);
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed:", e));
                }
            }
        }

        function connect() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log("Connected");
                $('.system-message').last().text('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                // Send join message
                ws.send(JSON.stringify({
                    type: 'join',
                    user: user,
                    room: room
                }));
            };
            
            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                if (msg.type === 'users') {
                    updateUserList(msg.users, msg.count);
                } else if (msg.type === 'stream_start') {
                    startStreamMessage(msg);
                } else if (msg.type === 'stream_chunk') {
                    appendStreamChunk(msg);
                } else if (msg.type === 'stream_end') {
                    endStreamMessage(msg);
                } else if (msg.type === 'weather') {
                    displayWeather(msg);
                } else {
                    appendMessage(msg);
                }
            };
            
            ws.onclose = function() {
                console.log("Disconnected");
                appendMessage({type: 'system', content: 'è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', timestamp: ''});
                setTimeout(connect, 3000); // Reconnect
            };
            
            ws.onerror = function(err) {
                console.error("WS Error", err);
            };
        }
        
        connect();
        
        let currentStreamId = null;
        let currentStreamContent = "";

        function startStreamMessage(msg) {
            currentStreamId = 'stream-' + Date.now();
            currentStreamContent = "";
            const area = $('#messageArea');
            const avatar = msg.user ? msg.user[0].toUpperCase() : '?';
            
            playSound('msg');

            const html = `
                <div class="message other" id="${currentStreamId}">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #238636">${avatar}</div>
                    <div>
                        <div class="message-meta" style="text-align: left">${msg.user}</div>
                        <div class="message-content markdown-body">
                            <span class="typing-indicator">...</span>
                        </div>
                    </div>
                </div>
            `;
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
        }

        function appendStreamChunk(msg) {
            if (currentStreamId) {
                currentStreamContent += msg.content;
                const contentDiv = $(`#${currentStreamId} .message-content`);
                try {
                    contentDiv.html(marked.parse(currentStreamContent));
                } catch(e) {
                    contentDiv.text(currentStreamContent);
                }
                const area = $('#messageArea');
                area.scrollTop(area[0].scrollHeight);
            }
        }

        function endStreamMessage(msg) {
            currentStreamId = null;
            currentStreamContent = "";
        }

        function displayWeather(msg) {
            // 1. Play Video
            const data = msg.data;
            // Try to find weather condition from data. 
            // We assume backend returns raw JSON. We need to extract weather type.
            // Adjust this based on actual API response structure.
            // Example structure guess: { data: { type: 'æ™´', wendu: '25', ... } }
            
            let weatherType = 'æ™´';
            let city = 'æœªçŸ¥';
            let temp = '';
            let wind = '';
            
            // Heuristic parsing
            if (data.data) {
                if (data.data.type) weatherType = data.data.type;
                if (data.data.city) city = data.data.city;
                if (data.data.wendu) temp = data.data.wendu;
                if (data.data.fengxiang) wind = data.data.fengxiang;
            } else if (data.weather) {
                weatherType = data.weather;
            }
            
            // Map to video file
            let videoFile = 'sun.mp4';
            if (weatherType.includes('é›¨')) videoFile = 'rain.mp4';
            else if (weatherType.includes('é›ª')) videoFile = 'snow.mp4';
            else if (weatherType.includes('é›·')) videoFile = 'thunder.mp4';
            else if (weatherType.includes('é£')) videoFile = 'wind.mp4';
            else if (weatherType.includes('é˜´') || weatherType.includes('äº‘')) videoFile = 'sun.mp4'; // No cloud video provided, use sun or maybe wind?

            const videoPath = `{{ url_for('chat.static', filename='weather/') }}${videoFile}`;
            const overlay = $('#weatherOverlay');
            const video = $('#weatherVideo');
            
            video.attr('src', videoPath);
            overlay.fadeIn();
            video[0].play();
            
            // Hide after video ends or 5 seconds
            video.on('ended', function() {
                overlay.fadeOut();
            });
            // Fallback if no ended event or loop
            setTimeout(() => {
                overlay.fadeOut();
            }, 8000);

            // 2. Display Card
            const area = $('#messageArea');
            const html = `
                <div class="message other">
                     <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: #e6a23c">å¤©</div>
                     <div>
                        <div class="message-meta">å°å¤©æ°”</div>
                        <div class="message-content weather-card">
                            <div class="weather-header">
                                <span class="weather-city">${city}</span>
                                <span class="weather-time">${msg.timestamp}</span>
                            </div>
                            <div class="weather-main">
                                <div class="weather-icon">
                                    <i class="fas ${getWeatherIcon(weatherType)}"></i>
                                </div>
                                <div class="weather-temp">${temp}Â°C</div>
                            </div>
                            <div class="weather-details">
                                <div>${weatherType}</div>
                                <div>${wind}</div>
                            </div>
                        </div>
                     </div>
                </div>
            `;
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
            playSound('msg');
        }

        function getWeatherIcon(type) {
            if (type.includes('é›¨')) return 'fa-cloud-rain';
            if (type.includes('é›ª')) return 'fa-snowflake';
            if (type.includes('é›·')) return 'fa-bolt';
            if (type.includes('é£')) return 'fa-wind';
            if (type.includes('æ™´')) return 'fa-sun';
            if (type.includes('äº‘')) return 'fa-cloud';
            return 'fa-sun';
        }

        function appendMessage(msg) {
            const area = $('#messageArea');
            let html = '';
            
            if (msg.type === 'system') {
                html = `<div class="system-message">${msg.content} <span style="font-size:10px;">${msg.timestamp}</span></div>`;
            } else if (msg.type === 'chat') {
                const isSelf = msg.user === user;
                
                // Play sound
                if (isSelf) {
                    playSound('self');
                } else {
                    playSound('msg');
                }

                const cls = isSelf ? 'self' : 'other';
                const avatar = isSelf ? user[0].toUpperCase() : (msg.user ? msg.user[0].toUpperCase() : '?');
                
                let renderedContent = msg.content;
                try {
                    renderedContent = marked.parse(msg.content);
                } catch(e) {
                    console.error("Markdown parse error", e);
                }

                html = `
                    <div class="message ${cls}">
                        <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; background: ${isSelf ? '#1f6feb' : '#238636'}">${avatar}</div>
                        <div>
                            <div class="message-meta" style="text-align: ${isSelf ? 'right' : 'left'}">${isSelf ? '' : msg.user}</div>
                            <div class="message-content markdown-body">
                                ${renderedContent}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            area.append(html);
            area.scrollTop(area[0].scrollHeight);
        }
        
        $('#sendBtn').click(sendMessage);
        $('#messageInput').keypress(function(e) {
            if (e.which == 13 && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        function sendMessage() {
            const input = $('#messageInput');
            const content = input.val().trim();
            if (content && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    content: content
                }));
                input.val('');
            }
        }
        
        function toggleUserSidebar() {
            $('.user-sidebar').toggleClass('active');
            if ($('.user-sidebar').hasClass('active')) {
                $('.settings-sidebar').removeClass('active');
            }
        }

        function switchTab(element, tabName) {
            // Remove active from all nav items
            $('.main-nav-item').removeClass('active');
            // Add active to clicked item
            $(element).addClass('active');

            if (tabName === 'settings') {
                $('.settings-sidebar').addClass('active');
                $('.user-sidebar').removeClass('active');
            } else {
                $('.settings-sidebar').removeClass('active');
            }
        }

        function closeSettingsSidebar() {
            $('.settings-sidebar').removeClass('active');
            // Revert active state to Chat
            $('.main-nav-item').removeClass('active');
            $('.main-nav-item[title="èŠå¤©"]').addClass('active');
        }

        function updateUserList(users, count) {
            $('#userCount').text(count);
            const list = $('#userList');
            list.empty();
            
            // Check for new users
            const currentUserSet = new Set(users);
            
            if (!isFirstLoad) {
                for (let u of currentUserSet) {
                    if (!previousUserList.has(u) && u !== user) {
                        playSound('user');
                        break; // Play once per update batch
                    }
                }
            }
            
            previousUserList = currentUserSet;
            isFirstLoad = false;

            users.forEach(u => {
                const isSelf = u === user;
                const html = `
                    <div class="user-item">
                        <div class="avatar" style="width: 30px; height: 30px; font-size: 12px; background: ${isSelf ? '#1f6feb' : '#238636'}">
                            ${u[0].toUpperCase()}
                        </div>
                        <div class="user-name" style="${isSelf ? 'color: #58a6ff;' : ''}">
                            ${u} ${isSelf ? '(æˆ‘)' : ''}
                        </div>
                    </div>
                `;
                list.append(html);
            });
        }

        // Emoji Logic
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const messageInput = document.getElementById('messageInput');
        
        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜',
            'ğŸ˜', 'ğŸ˜˜', 'ğŸ¥°', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤©', 'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜',
            'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´',
            'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²',
            'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©',
            'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬',
            'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¥³', 'ğŸ¥´', 'ğŸ¥º',
            'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ’€', 'ğŸ‘»', 'ğŸ‘½',
            'ğŸ¤–', 'ğŸ’©', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ‘‹',
            'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ',
            'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘',
            'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦µ', 'ğŸ¦¿',
            'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹'
        ];

        // Populate Emojis
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = emoji;
            span.onclick = function() {
                messageInput.value += emoji;
                messageInput.focus();
            };
            emojiGrid.appendChild(span);
        });

        // Toggle Panel
        emojiBtn.onclick = function(e) {
            e.stopPropagation();
            if (emojiPanel.style.display === 'none') {
                emojiPanel.style.display = 'block';
            } else {
                emojiPanel.style.display = 'none';
            }
        };

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (emojiPanel.style.display !== 'none' && !emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.style.display = 'none';
            }
        });
    </script>
</body>
</html>